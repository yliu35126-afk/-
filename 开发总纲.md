🧩 Niushop 抽奖系统二开插件 — 技术版 SRS

Version 1.0 · Markdown Edition

1. 概述
1.1 项目背景

本系统基于 Niushop 商城系统 二次开发，实现一个支持：

抽奖活动（多价池）

分润体系

供应商铺货

商家自营抽奖商品

线下设备抽奖与核销

财务结算与提现

的综合抽奖插件模块。

1.2 系统目标

将 Niushop 商城改造为支持【抽奖 + 分润 + 核销 + 提现】的商城体系，
所有会员、商家、供应商、代理、设备主均参与同一财务闭环。

1.3 系统角色
角色	权限说明
平台管理员	管理价池、奖池、分润模板、供应商结算
供应商	上传商品、设置供货价、查看结算
商家	上传自营商品、从供应商库选品、配置奖池
设备主	控制设备抽奖出奖
推广人	推广抽奖活动，获得分润
用户	参与抽奖、支付、核销
2. 系统模块结构
抽奖系统模块结构
│
├─ 价池管理
│   ├─ 可自定义价档（19, 29, 39, 49, 59...）
│   ├─ 每个价池定义显示价与价区间
│
├─ 奖品管理
│   ├─ 商家商品
│   ├─ 供应商商品
│   ├─ 权重、库存、大奖标记
│
├─ 奖池挂接
│   ├─ 16宫格配置（奖品 + 权重 + 顺序）
│   └─ 校验奖品价区间合法性
│
├─ 抽奖逻辑配置
│   ├─ 实时概率模式
│   ├─ 轮次控制模式
│   ├─ 自动重置轮次
│
├─ 设备管理
│   ├─ 绑定商家、代理、奖池
│   ├─ 查看心跳、日志、当前奖池
│
├─ 分润模板
│   ├─ 各角色金额配置
│   ├─ 校验合计 ≤ 抽奖价
│
├─ 抽奖记录 / 核销管理 / 提现管理
│   ├─ 查看抽奖流水、核销状态
│   └─ 提现审核与打款

3. 价池机制（动态可配置）
3.1 数据结构：lottery_price_tier（实际表）
字段名	类型	说明
tier_id	bigint	主键
site_id	int	站点ID
title	varchar(64)	价池名称（如“29元档”）
price	decimal(10,2)	抽奖价（P）
min_price	decimal(10,2)	允许最小供货价（0 表示不限制）
max_price	decimal(10,2)	允许最大供货价（0 表示不限制）
status	tinyint	1启用 / 0禁用
profit_json	text	分润模板JSON（见 6.2）
create_time	int	创建时间（时间戳）
update_time	int	更新时间（时间戳）
3.2 商品入池规则
if product.participate_in_lottery == true:
    show all pool_tiers where status = 1
    selected_tier = user_select(pool_tiers)
    if product.supply_price < selected_tier.min_price:
        reject("供货价低于价池下限")
    if product.supply_price > selected_tier.max_price:
        reject("供货价高于价池上限")
    bind(product, selected_tier)

3.3 校验逻辑
条件	错误提示
未勾选“参与抽奖”	ERR_LOTTERY_DISABLED
供货价不在价池区间	ERR_POOL_PRICE_INVALID
价池已停用	ERR_POOL_DISABLED
4. 奖品管理模块
4.1 数据结构：lottery_slot（奖品格子配置，实际表）
字段	类型	说明
slot_id	bigint	主键
board_id	bigint	所属盘ID（见 lottery_board）
position	int	格子序号 0-15
prize_type	varchar(16)	奖品类型：goods,coupon,balance,thanks
source_type	varchar(20)	来源：self/platform/supplier（默认 self）
title	varchar(64)	格子标题
img	varchar(255)	展示图URL（可为空；为空时可用商品封面）
goods_id	int	商品ID（prize_type=goods 时有效）
sku_id	int	SKU ID（可选）
inventory	int	库存/发放次数
weight	int	抽中权重
value	decimal(10,2)	面值（余额/券面值等）
create_time	int	创建时间
update_time	int	更新时间

说明：商品与价池的参与关系在 lottery_goods_tier 维护（每站点每商品一条）。

4.2 数据结构：lottery_goods_tier（商品参与抽奖与价池绑定）
字段	类型	说明
id	int	主键
site_id	int	站点ID
goods_id	int	商品ID
enable	tinyint	是否参与抽奖（0/1）
tier_id	int	历史兼容：单选代表价池ID（保留）
tier_ids	text	JSON数组：可多选参与的价池ID集合
create_time	int	创建时间
update_time	int	更新时间
5. 抽奖逻辑配置
5.1 模式选项
模式	描述
实时概率	每次抽奖按权重计算中奖
轮次控制	按轮次顺序出奖（控制频率）
自动重置	库存用尽自动归零
5.2 抽奖算法伪代码
function drawPrize(pool_id):
    prize_list = getActivePrizes(pool_id)
    prize_list = filter(prize_list, stock > 0)
    total_weight = sum(prize.weight for prize in prize_list)
    rand = random(0, total_weight)
    cumulative = 0
    for prize in prize_list:
        cumulative += prize.weight
        if rand <= cumulative:
            return prize
    return None

6. 分润与结算逻辑
6.1 分润计算公式
P = 抽奖价
K = 供货价
M = 毛利池 = P - K

6.2 分润模板：lottery_price_tier.profit_json（实际）
说明：在 lottery_price_tier.profit_json 中以键值对形式存储，键建议使用
platform、supplier、promoter、installer、owner 等；
数值既可为比例（≤1 的小数，按毛利 M 分配），也可为固定金额（>1 的数值）。
系统在结算时自动判断并按比例或固定金额分配，若合计超出毛利将按比例缩放。
6.3 结算分支逻辑
if prize.source_type == "supplier":
    pay supplier K
    distribute (P - K) according to profit_template
else if prize.source_type == "merchant":
    distribute P according to profit_template

7. 接口设计（API Spec）
模块	接口	请求参数	响应字段	错误码
获取价池	GET /api/amount-tiers?device_sn=SN	device_sn	[ { tier_id, name, display_price } ]	1001 无效设备
获取奖品格子	GET /api/pool/{tier_id}/grid?limit=16	tier_id	[ { prize_id, name, image, weight } ]	1002 奖池为空
创建订单	POST /api/order	user_id, tier_id	order_id	2001 支付异常
支付回调	POST /api/pay/notify/wx	pay_status	success	2002 签名错误
查询中奖结果	GET /api/order/{id}	order_id	prize_info	3001 未中奖
获取核销码	GET /api/prize/code/{order_id}	order_id	qr_url	3002 无效订单
查询钱包	GET /api/wallet/balance	user_id	balance	4001 用户不存在
提现申请	POST /api/memberwithdraw/apply	amount	status	4002 余额不足
8. 错误码定义
错误码	含义
ERR_POOL_PRICE_INVALID	供货价不在价池区间
ERR_ORDER_STATUS_INVALID	订单状态异常
ERR_PRIZE_OUT_OF_STOCK	奖品库存不足
ERR_PAYMENT_FAILED	支付失败
ERR_PERMISSION_DENIED	无权限操作
ERR_SUPPLIER_DISABLED	供应商已停用
ERR_WITHDRAW_BALANCE_NOT_ENOUGH	提现金额超过余额
9. 数据表设计（关键表，已与实际对齐）
表名	说明
lottery_board	抽奖盘定义
lottery_slot	奖品格子（含 prize_type/goods_id/weight 等）
lottery_price_tier	价档定义（含 profit_json、min/max 供货价）
device_info	设备信息（含绑定的 board_id 等）
device_price_bind	设备-价档绑定
lottery_record	抽奖记录（含 result、order_id、ext 扩展）
lottery_profit	分润流水（结算后回写各角色金额）
lottery_goods_tier	商品参与抽奖与价池绑定（多选）
lottery_settlement	抽奖结算占位表（状态：pending/done/failed）
settlement_amount	供应商结算明细（抽奖金额、供货价、毛利）
goods（新增列）	供货与参与字段：supply_price、lottery_participation、lottery_tier_ids、source_type

名词对照（历史草案 → 实际表名/字段）：
- display_price → price；name → title；ns_pool_tier → lottery_price_tier
- ns_prize_item / ns_prize_grid → 统一为 lottery_slot
- ns_profit_template → lottery_price_tier.profit_json
- ns_order_lottery（未落地）→ 以普通订单为主，lottery_record.order_id 建链
- ns_prize（未落地）→ 使用 lottery_record 记录抽奖结果
- ns_supplier_settlement → settlement_amount（明细）；分润总账使用 lottery_profit
- ns_wallet（未落地）→ 依托平台会员账户余额体系（balance/balance_money），无独立钱包表
10. 后台界面字段建议
页面	字段	控件类型	校验逻辑
商品管理	是否参与抽奖	checkbox	选中后显示价池选择框
商品管理	价池选择	select	校验供货价区间
奖池管理	价池区间	input(min,max)	不可重叠
奖池挂接	奖品格子	drag&drop grid	自动保存权重与顺序
抽奖配置	模式选择	radio	轮次/实时概率切换
分润模板	各角色金额	number	合计 ≤ 价池价
11. 业务流程图（文字版）
用户点击抽奖
  ↓
创建订单（附带奖池ID）
  ↓
支付成功（回调）
  ↓
进入抽奖逻辑（按权重出奖）
  ↓
扣减库存
  ↓
记录抽奖流水 lottery_record（含是否中奖与奖品信息）
  ↓
计算分润 → 写入 lottery_profit
  ↓
若来源为供应商 → settlement_amount 记明细
  ↓
生成核销码
  ↓
前端展示中奖结果
  ↓
用户核销 / 商家发货

12. 附录：开发注意事项

所有金额字段统一使用 decimal(10,2) 精度

分润结算需在事务中执行（防止漏账）

抽奖逻辑建议使用 Redis 分布式锁

核销码生成采用加盐 + 随机数，防伪造

建议在后台增加日志记录模块，用于追踪抽奖/结算/核销行为
