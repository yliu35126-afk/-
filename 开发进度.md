# 抽奖插件开发进度（持续更新）

更新时间：2025-10-28

## 里程碑与阶段进度
- M1 数据对齐与后台基础（目标：数据表/基础管理/编辑页）
  - 状态：进行中（85%）
  - 已完成：
    - 文档《开发总纲.md》与实际表结构完全对齐
    - turntable/device_turntable 的 Slot 列表、编辑接口打通
    - Slot 编辑页集成商品/SKU 选择器（新增、编辑均支持）
    - 即时联动：切换“类型=商品”即刻显示选择器（双插件已生效）
    - 前端校验：prize_type=goods 未选商品阻止提交；非商品提交前自动清空 goods_id/sku_id
    - 后端校验：非商品类型清空 goods_id/sku_id；商品类型强校验 goods_id
  - 待完成：
    - Slot 新增页在 device_turntable 同步 UI/交互（如需要）

- M2 奖品池配置与抽奖路径（目标：抽奖接口/库存权重）
  - 状态：未开始（0%）

- M3 分润与结算闭环（目标：profit_json 执行、流水与结算）
  - 状态：未开始（0%）

- M4 设备联动与验证（目标：设备绑定/拉取盘与格子/心跳）
  - 状态：未开始（0%）

- M5 财务、提现与核销（目标：账户变动、提现、核销流程）
  - 状态：未开始（0%）

## 今日进展
- 修复编辑页“类型=商品”即时显示选择器（LayUI 事件 + 原生 change 兜底）
- 来源字段保留，并仅在商品场景下可见
- 新增前端提交校验：prize_type=goods 时必须选择商品（goods_id>0），否则阻止提交
- 后端控制器新增业务校验与清理逻辑（两个插件）：
  - 商品奖必须有 `goods_id`；
  - 非商品奖自动清空 `goods_id/sku_id`，避免脏数据

## 自测清单（本轮）
- 切换类型=商品：选择器即时出现，选择商品后自动回填 `goods_id/sku_id`，封面缺省回填。
- 未选商品直接保存：前端阻止并提示“请选择商品后再保存”。
- 切换到余额/优惠券/谢谢参与：保存后数据库 `goods_id/sku_id` 为 0。
- 缺少 `goodsSelect`：点击“选择商品”弹出“商品选择器未加载，请检查依赖”。

## 明日计划
- 校验并优化商品选择器：确保 `goodsSelect` 依赖可用，必要时内嵌弹窗模板
- 增加表单端必填规则（prize_type=goods 时校验 `goods_id`）
- 完成抽奖盘/格子获取接口雏形（设备/前端可拉取）

## 相关改动清单（本次）
- 文件：
  - addon/turntable/admin/view/slot/edit.html（即时显示 + 去重 + 兜底事件）
  - addon/device_turntable/admin/view/slot/edit.html（同上）
  - addon/turntable/admin/controller/Slot.php（后端校验/清理）
  - addon/device_turntable/admin/controller/Slot.php（后端校验/清理）
  - 开发总纲.md（新增章节：前端交互与校验、接口现状、表单规范、变更记录）

## 验收要点（阶段）
- 编辑页：切换为“商品”即刻出现选择器，保存成功后列表可见字段更新
- 后端：非商品类型时数据库中的 `goods_id/sku_id` 为 0
- 错误提示：商品奖漏选商品时返回“请选择商品”