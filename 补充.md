1. 核心补充需求
1.1 价池区间与入池校验

当前问题：现有系统未实现价池区间（min_price 和 max_price）校验，商品上传时未对供货价（K）进行价池范围校验。

补充需求：

在 lottery_price_tier 表中增加字段：

min_price：价池最小价格

max_price：价池最大价格

在商品上传时，新增字段：

supply_price：商品的供货价（K）

lottery_participation：是否参与抽奖

selected_price_tier：选择的价池（可选择多个价池）

后台校验：

商品入池校验：根据 supply_price 校验商品是否符合选择的价池区间（min_price ≤ supply_price ≤ max_price）。

商品选择价池：根据供货价，后台会提示用户选择合适的价池，如果选择错误或不匹配，系统应提示错误。

数据库更新：

lottery_price_tier 表增加 min_price 和 max_price 字段。

商品表（如 ns_goods）增加 supply_price、lottery_participation、selected_price_tier 字段。

1.2 商品来源与供货价流转

当前问题：现有系统未能处理供应商和商家商品的不同来源问题，尤其是供应商的供货价（K）与商家的抽奖价（P）未进行流转。

补充需求：

商品来源：

新增字段：source_type（enum: supplier, merchant），标明商品来源。

供应商商品：结算时使用供应商供货价（K）。

商家商品：结算时使用商家抽奖价（P）。

供货价与分润流转：

当抽奖成功时，若商品来自供应商，系统需根据 supply_price （供货价）来计算供应商结算。

系统需从 lottery_price_tier 中获取奖池金额（P），计算毛利池（M = P - K），并根据分润模板计算分润。

数据库更新：

ns_prize_item 表增加 source_type 字段。

ns_supplier_settlement 表新增：settlement_amount 字段用于记录供应商结算金额。

2. 核心功能开发路径
2.1 价池区间与入池校验
开发思路：

数据表设计：

在 lottery_price_tier 表中加入 min_price 和 max_price 字段，用来定义每个价池的价格区间。

商品模型扩展：

在 ns_goods 表中增加 lottery_participation（是否参与抽奖）和 selected_price_tier（选择的价池）字段。

后台操作：

在商品上传页面，增加“是否参与抽奖”和“选择价池”的选择框。

根据商品供货价（K）判断商品是否符合选择的价池区间，如果不符合，则提示错误。

技术实现：
// 校验商品供货价与价池区间
public function checkPriceTier($product_id, $tier_id) {
    $product = Goods::find($product_id);
    $tier = PriceTier::find($tier_id);
    
    if ($product->supply_price < $tier->min_price || $product->supply_price > $tier->max_price) {
        throw new Exception("商品供货价不在价池区间内");
    }
}

2.2 商品来源与供货价流转
开发思路：

商品来源处理：

为每个商品增加 source_type 字段（供应商或商家），并根据来源决定结算方式。

供应商商品，结算时使用供货价（K）进行结算。

商家商品，结算时使用商家抽奖价（P）进行结算。

分润结算流程：

通过分润模板计算每个参与方的分润，平台使用剩余毛利部分（M = P - K）进行结算。

技术实现：
// 结算逻辑
public function settlePrize($order_id, $prize_id) {
    $order = LotteryOrder::find($order_id);
    $prize = Prize::find($prize_id);

    if ($prize->source_type == 'supplier') {
        $supplier_settlement = new SupplierSettlement();
        $supplier_settlement->amount = $prize->supply_price;
        $supplier_settlement->order_id = $order_id;
        $supplier_settlement->save();
        
        // 分润计算
        $this->distributeProfit($order, $prize);
    } else {
        // 商家自营商品结算
        $this->distributeProfit($order, $prize);
    }
}

2.3 分润结算与账单管理
开发思路：

分润模板：

在 lottery_price_tier 中维护分润模板，包含平台、商家、供应商等角色的分润比例。

结算与账单管理：

每次抽奖完成并确认核销后，按照分润模板计算分润并写入 ns_lottery_profit 表。

支持结算状态的变更（pending → settled → revoked）。

技术实现：
// 分润计算与写入
public function distributeProfit($order, $prize) {
    $profit_data = json_decode($order->price_tier->profit_json, true);
    $profit = $order->amount * $profit_data['platform'];

    foreach ($profit_data as $role => $percentage) {
        $profit_amount = $order->amount * $percentage;
        $profit_record = new ProfitRecord();
        $profit_record->order_id = $order->id;
        $profit_record->role = $role;
        $profit_record->amount = $profit_amount;
        $profit_record->save();
    }
}

3. 系统补充建议
3.1 完整订单与钱包闭环

建议完善 ns_order_lottery 表的独立订单记录，并通过该表与钱包系统进行闭环，确保每个抽奖订单都能有对应的结算记录、退款保护、和钱包余额更新。

3.2 分润模板与平台结算逻辑

建议固化分润模板，并将分润比例校验清晰化，确保平台部分能够自动计算剩余毛利，并在后台管理系统中明确显示“平台结算余额”。

3.3 商品上传与选择价池

需完善商品上传时的“是否参与抽奖”和“选择价池”的选项，确保商家/供应商根据供货价自动或手动选择适合的价池进行绑定。