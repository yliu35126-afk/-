核心抽奖算法与实现
一、概率控制模式（轮次模式）
1️⃣ 轮次控制模式（Round Mode）概念：

每台设备的16格奖池在一次抽奖过程中不会立刻重置，直到这一轮的所有奖品都被抽取完毕，系统才会重置奖池（即把所有格的库存归零）。

计算方式：每一格的“中奖概率”是当前格的奖品数占当前奖池的总奖品数的比例。

2️⃣ 轮次控制算法计算公式：

总奖品数：所有16格奖品数量的总和

概率计算公式：当前格的概率 = 当前格奖品数 / 总奖品数

举个例子（假设 16 格奖池配置如下）：
格号	奖品数量	概率计算
1	20	20 / 190 = 10.52%
2	20	20 / 190 = 10.52%
3	30	30 / 190 = 15.78%
4	50	50 / 190 = 26.31%
5	70	70 / 190 = 36.84%
6~16	0	0%

总奖品数 = 20 + 20 + 30 + 50 + 70 = 190。

每格概率：比如格号1的概率 = 20 / 190 = 10.52%。

重置机制：所有奖品都被抽取完后，轮次结束，设备端会将“库存清零”并触发重置操作，之后重新开始新的轮次。

二、实时概率模式（Live Mode）
1️⃣ 实时概率模式概念：

在实时概率模式下，每一次抽奖的概率都是动态计算的。每次抽中一个奖品后，剩余奖品的数量会影响下一轮的中奖概率。

计算方式：每一格的概率=当前格的奖品库存÷所有格的总库存。

2️⃣ 实时概率算法计算公式：

当前格概率 = 当前格库存 / 总库存

当一格奖品被抽取后，它的库存数会减少，其他格的中奖概率会动态增加。

举个例子：
格号	奖品数量	概率计算（初始）	概率计算（抽取后）
1	20	20 / 190 = 10.52%	19 / 189 = 10.05%
2	20	20 / 190 = 10.52%	20 / 189 = 10.58%
3	30	30 / 190 = 15.78%	30 / 189 = 15.87%
4	50	50 / 190 = 26.31%	50 / 189 = 26.46%
5	70	70 / 190 = 36.84%	70 / 189 = 37.04%

实时更新：假设格号1的奖品被抽中（库存减1），系统会重新计算每一格的概率。

优势：

动态适应：系统会自动调节概率，库存越多的格子，中奖的概率也会越高，适合抽奖池中的库存持续变化的情况。

🧰 方案实施（只涉及概率部分）
1. 数据库设计
ns_device（新增字段）
字段	类型	说明
prob_mode	ENUM	概率模式（round
prob_json	JSON	存储16格的概率数据，包括每一格的权重和库存
auto_reset	TINYINT	自动重置轮次开关
ns_prize_grid（格子映射）
字段	类型	说明
device_id	INT	设备ID
grid_no	TINYINT	1-16格号
prize_id	INT	奖品ID
weight	INT	当前格的权重
allow_fallback	TINYINT	是否允许兜底奖（默认不勾选）
2. 后端逻辑
概率配置更新接口（推送给设备）

接口路径：/api/device/probability/update

接口方法：POST

请求内容：

{
  "device_id": "DEV_XXXX",
  "mode": "round",
  "grids": [
    {"no": 1, "weight": 2},
    {"no": 2, "weight": 4},
    ...
    {"no": 16, "weight": 0}
  ]
}

概率计算模块（轮次模式/实时模式）

轮次模式：所有格的奖品数一轮结束后才清空并重置。

实时模式：每次抽奖后更新每格库存和中奖概率。

中奖结果接口

接口路径：/api/lottery/result

请求内容：

{
  "device_id": "DEV_XXXX",
  "grid_no": 5,
  "result": "win",
  "ts": 1730001234
}

3. WebSocket 服务（消息推送给设备）

推送内容：概率配置（16格数据）。

消息格式：

{
  "cmd": "update_probability",
  "device_id": "DEV_XXXX",
  "mode": "round",
  "grids": [
    {"no": 1, "weight": 2},
    {"no": 2, "weight": 4},
    ...
    {"no": 16, "weight": 0}
  ]
}


最终目标：

16格奖池，支持两种概率模式：轮次控制与实时动态概率。

后端：管理概率、权重、库存、重置，确保设备顺利获取和执行配置。

设备：执行概率计算并将结果返回，后台根据返回结果做库存扣减、分润和核销。