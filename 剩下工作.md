# 交接文档：系统现状与商用待办

本文件用于交接当前“设备抽奖/转盘”系统的现状、已完成内容、尚需工作与上线前的商用保障要点。包含后端接口、数据库结构、路由、前端联调和运维测试建议。

## 一、系统现状概述
- 核心模块
  - 抽奖引擎与转盘插件：`addon/turntable` 负责盘与格子的配置、奖品列表与抽奖记录。
  - 设备层：`device_info`、`device_price_bind` 绑定设备与盘、价档等（见《规划3.0.md》）。
  - 后端接口：`app/api/controller` 下新增多项接口以支撑抽奖、分润、奖品管理、订单记录、退款等流程。
  - 客户端：`clients/miniapp`（小程序）与 `clients/app`（Android）已有基础API路由与数据处理逻辑。

- 已完成的数据库与接口改动
  - 数据库变更（`upgrade.sql` 已执行）：
    - 新增 `lottery_prize`（抽奖奖品管理表）。
    - 新增 `ns_lottery_profit`（与抽奖记录关联的分润明细，按角色细化）。
    - 其他已有变更：`device_probability_grid` 创建；`device_info` 增加 `prob_mode`、`prob_json`、`auto_reset`、`device_secret`；`lottery_record` 增加 `round_no`、`inv_snapshot`（升级发现部分列已存在，脚本自动跳过或提示）。
  - 路由：`public/router.php` 已支持常规 API 解析；仅少量历史兼容重写（如 `probabilityUpdate`），本次新增接口无需额外重写。
  - 控制器与接口：
    - 设备：`Device.smartLottery`、`Device.profitprizes`
    - 奖品：`Prizeapi.list`、`Prizeapi.create`
    - 订单：`Orders.getLotteryRecords`
    - 抽奖核销与分润：`Lottery.verify`、`Lottery.scan`（别名）与 `Lottery.distribute`
    - 退款：`Order.refund`（校验已核销禁退，未核销回滚库存）
  - 转盘插件：
    - `addon/turntable/api/controller/Turntable.php` 已有 `prizeList`（16格奖品列表）与 `record`（记录查询）。

- 关键业务规则现状
  - 16格奖品列表逻辑：移除“谢谢参与”，用真实奖品填充至16格；并根据设备绑定信息可返回当前价档与分润信息（参考 `Lottery.php::prizeList`）。
  - 抽奖记录：`lottery_record` 包含 `member_id`、`device_id`、`board_id`、`slot_id`、`prize_type`、`goods_id`、`tier_id`、`amount`、`round_no`、`result`（hit/miss）、`order_id`、`inv_snapshot`、`ext`、`create_time`。
  - 退款：若 `ns_lottery_profit` 中 `order_id` 状态为 `settled`（已核销/已分润），拒绝退款；否则对命中且为 `goods` 的记录回滚 `lottery_slot.inventory`。

## 二、尚需完成的工作（商用所需）
- 流程与幂等
  - 退款幂等：订单主表增加退款状态字段与操作日志；防重复回滚与重复调用。
  - 核销/分润幂等：`Lottery.verify/distribute` 对同一 `record_id/order_id` 的重复请求做幂等保护；避免重复入账与状态错乱。

- 安全与鉴权
  - 设备回调统一校验：签名与时间戳校验在 `Lottery.result`/设备相关接口中规范化使用 `device_secret`；统一错误码与日志。
  - API 接口鉴权：商户端与平台端的 token 校验、角色权限（核销员/店员）细化；接口限流与参数校验（防止恶意调用）。

- 分润与核销闭环
  - 分润明细落库：`ns_lottery_profit` 需要完整的角色维度（平台/商家/运营商/设备方等）与金额、比例、来源记录（`record_id`）。
  - 状态流转：明确 `pending -> settled -> reversed` 状态与触发条件（核销通过→settled；退款成功→reversed），并联动订单与记录。
  - 核销扫码：`Lottery.verify/scan` 与小程序前端扫码页面打通；二维码内容约定、权限校验、核销结果提示。

- 库存与轮次管理
  - 并发与事务：抽奖命中库存扣减与退款库存回滚需在事务中保证一致性；建议为 `lottery_slot` 操作增加行锁或乐观锁版本字段。
  - 轮次模式：`round_no` 与 `round_qty` 的重置机制与自动重置（`auto_reset`）联动；在回调写入记录时保持快照一致性（`inv_snapshot`）。

- 订单与支付集成
  - 退款对接支付：将 `Order.refund` 与支付网关（微信/支付宝等）打通，完成实际资金原路退回；处理失败补偿与重试。
  - 订单状态打通：抽奖型订单的状态定义与变更（待核销/已核销/已退款）与售后流程；前端展示统一。

- 前端联调
  - 小程序：完善 `orders/order.ts` 中退款按钮、核销扫码页、抽奖记录展示；`utils/scanner.js` 与 `api.js` 接口联调。
  - Android：`LotteryProcessor.kt` 与 `PrizeApiService.kt` 联调新增接口返回结构；错误处理与重试策略完善。

- 接口文档与约定
  - 输出 OpenAPI/Markdown 接口文档：路径、参数、响应示例、错误码、鉴权说明；覆盖新增接口：
    - `POST /api/device/smartLottery`
    - `GET /api/device/profitprizes`
    - `GET /api/prize/list`、`POST /api/prize/create`
    - `GET /api/orders/getLotteryRecords`
    - `POST /api/lottery/verify`、`POST /api/lottery/scan`（别名）
    - `POST /api/lottery/distribute`
    - `POST /api/order/refund`

- 监控与运维
  - 日志与审计：接口入参、设备回调、核销与分润、退款操作均记录操作日志与关键字段，便于审计与追溯。
  - 指标与告警：QPS、错误率、库存异常（负库存/频繁回滚）报警；设备离线与回调超时报警。
  - 部署：生产环境 Web 服务器、HTTPS、数据库备份策略、缓存与会话配置（Redis）；`start-dev.bat` 对应生产启动脚本与服务管理。

- 测试与验收
  - 单元测试：控制器方法的参数校验、状态流转、事务提交/回滚。
  - 集成测试：抽奖→记录→核销→分润→退款的主链路；并发抽奖与并发退款的竞态测试。
  - E2E 测试：前后端联调流程、扫码核销、异常网络场景与重试。

- 数据迁移与备份
  - 迁移：旧数据与新表（`lottery_prize`、`ns_lottery_profit`）字段映射；`slot_id` 作为 `prize_id` 的统一约定，避免歧义。
  - 备份：上线前完整库备份与回滚方案；迁移脚本的幂等检查与断点续迁。

## 三、接口与表的详细约定（简要）
- `Order.refund`
  - 入参：`order_id`
  - 规则：若 `ns_lottery_profit.order_id` 的 `status='settled'` 则拒绝退款；否则对 `lottery_record` 里 `result='hit' && prize_type='goods'` 回滚 `lottery_slot.inventory`。

- `ns_lottery_profit`
  - 关联：`record_id`（关联 `lottery_record`）、`order_id`
  - 字段建议：`role`（平台/商家/设备方等）、`rate`、`amount`、`status`（`pending/settled/reversed`）、`create_time`、`settle_time`

- `lottery_prize`
  - 用途：抽奖奖品基础管理；与转盘 `lottery_slot` 的奖品配置统一。

- `lottery_record`
  - 关键：`round_no`、`inv_snapshot` 用于记录当次库存与轮次状态；`ext` 存放回调来源与附加信息（例如设备回调、核销快照）。

## 四、风险与注意事项
- 升级脚本幂等：部分列已存在导致跳过或告警；迁移脚本需支持重复执行不破坏现有结构。
- `prize_id` 约定：当前实现使用 `slot_id` 作为奖品标识返回给客户端；需在文档与代码中统一此约定，避免出现既有 `goods_id` 又称 `prize_id` 的混乱。
- 并发一致性：抽奖和退款的库存修改必须置于事务，必要时加锁；避免负库存或重复回滚。
- 核销来源：扫码核销的二维码规范与权限控制需明确（店员/核销员角色）；防伪造请求。

## 五、交接建议与优先级
- P0
  - 完成核销与分润闭环：`verify → distribute → ns_lottery_profit.settled` 与退款反向流 `refund → profit.reversed`。
  - 落地幂等与并发控制：订单退款幂等、核销幂等、库存事务与锁。
  - 文档与前端入口：补齐 OpenAPI 文档，前端新增退款与扫码核销入口并联调。

- P1
  - 支付网关对接与自动化回滚；错误重试与补偿机制。
  - 监控与报警接入；错误日志清洗与归档。
  - 集成与E2E测试覆盖抽奖主链路与异常分支。

- P2（持续优化）
  - 抽奖算法与概率配置后台化；价档策略可视化配置与审计。
  - 数据报表：分润、库存、中奖率、设备在线率等可视化看板。

## 六、运行与验证
- 开发环境
  - 启动：在项目根目录执行 `start-dev.bat`，访问 `http://localhost:8000/`。
  - 路由：`public/router.php` 已处理静态与 API 委托；新增接口无需额外重写。
- 验证建议
  - 顺序测试：设备抽奖→抽奖记录生成→扫码核销→分润入账→订单退款（拒绝/回滚）→状态与库存校验。
  - 边界测试：高并发抽奖、重复扫码、网络抖动与设备回调延迟。

如需针对具体模块继续开发，请以本文件的优先级为准推进，并在每次迭代结束更新接口文档与迁移脚本说明。