<!--pages/game-launcher/game-launcher.wxml-->
<navigation-bar title="订单详情" back="{{true}}" color="black" background="white"></navigation-bar>

<view class="payment-success-container">
  <!-- 绿色背景区域 -->
  <view class="success-header">
    <!-- 白色圆圈和对勾 -->
    <view class="success-circle">
      <view class="checkmark">✓</view>
    </view>
    
    <!-- 已支付文本 -->
    <text class="success-text">已支付</text>
  </view>
  
  <!-- 白色悬浮卡片 -->
  <view class="floating-card">
    <!-- 金额显示 -->
    <view class="amount-section">
      <text class="currency">¥</text>
      <text class="amount">{{paymentAmount}}</text>
    </view>
    
    <!-- 订单详情 -->
    <view class="order-details">
      <view class="detail-row">
        <text class="detail-label" style="color: #000000;">订单编号</text>
        <text class="detail-value" style="color: #000000;font-size: 11px;">{{orderNumber}}</text>
      </view>
      <view class="detail-row">
        <text class="detail-label" style="color: #000000;">付款时间</text>
        <text class="detail-value" style="color: #000000;">{{paymentTime}}</text>
      </view>
      <!-- 设备码：紧贴付款时间下方显示 -->
      <view class="detail-row">
        <text class="detail-label" style="color: #000000;">设备码</text>
        <text class="detail-value" style="color: #000000;">{{deviceCode || '未设置'}}</text>
      </view>
    </view>
  </view>
  
  <!-- 主要内容区域 -->
  <view class="content-area">
    <!-- 虚线分隔 -->
    <view class="dotted-divider"></view>
    
    <!-- 分享按钮 -->
    <view class="share-section" style="margin-bottom: 30px;">
      <button class="share-button" bindtap="shareToTimeline">
        <text class="share-text">分享 朋友圈有奖</text>
      </button>
    </view>
    
    <!-- 抽奖状态 -->
    <view class="lottery-status" style="margin-bottom: 30px;">
      <text class="status-text">{{isLotteryFinished ? '已抽奖' : gameStatusText}}</text>
    </view>
    
    <!-- 底部按钮组 -->
    <view class="bottom-buttons" wx:if="{{!isLotteryFinished}}">
      <button class="lottery-btn {{gameStatus !== 'stopped' ? 'disabled' : ''}}" 
              bindtap="startLottery" 
              disabled="{{gameStatus !== 'stopped'}}">
        {{gameStatus === 'starting' ? '启动中...' : (gameStatus === 'running' ? '抽奖中...' : (gameStatus === 'waiting' ? '设备占用中...' : '抽奖'))}}
      </button>
      <button class="refund-btn {{gameStatus !== 'stopped' ? 'disabled' : ''}}" 
              bindtap="requestRefund"
              disabled="{{gameStatus !== 'stopped'}}">退款</button>
    </view>
  </view>
</view>

<!-- 中奖结果弹窗 -->
<view class="win-modal {{showWinModal ? 'show' : ''}}" bindtap="closeWinModal">
  <view class="win-modal-content" catchtap="preventClose">
    <!-- 关闭按钮 -->
    <view class="close-btn" bindtap="closeWinModal">✕</view>
    
    <!-- 恭喜标题 -->
    <view class="win-title">🎉 恭喜中奖！</view>
    
    <!-- 奖品信息 -->
    <view class="prize-info" wx:if="{{winResult}}">
      <!-- 奖品图片 -->
      <view class="prize-image-container" wx:if="{{winResult && winResult.image}}">
        <image class="prize-image" 
               src="{{winResult.image}}" 
               mode="aspectFit"></image>
      </view>
      
      <!-- 奖品详情 -->
      <view class="prize-details">
        <view class="prize-name" wx:if="{{winResult.prize_name || (winResult.prize_info && winResult.prize_info.name)}}">
          {{winResult.prize_name || winResult.prize_info.name}}
        </view>
        <view class="prize-desc" wx:if="{{winResult.description}}">{{winResult.description}}</view>
        <view class="prize-desc" wx:if="{{!winResult.description && winResult.prize_info}}">
          恭喜您抽中了奖品：{{winResult.prize_info.name}}
        </view>
        <view class="prize-value" wx:if="{{winResult.value}}">价值：¥{{winResult.value}}</view>
        <view class="prize-timestamp" wx:if="{{winResult.timestamp}}" style="color: #999; font-size: 24rpx; margin-top: 10rpx;">
          中奖时间：{{winResult.formattedTime || winResult.timestamp}}
        </view>
      </view>
    </view>
    
    <!-- 操作按钮 -->
    <view class="win-actions">
      <button class="claim-btn" bindtap="showShareGuide">分享朋友圈</button>
      <button class="continue-btn" bindtap="closeWinModal">继续</button>
    </view>
  </view>
</view>

<!-- 分享弹窗 -->
<view class="share-modal {{showShareModal ? 'show' : ''}}" bindtap="hideShareModal">
  <view class="share-modal-content" catchtap="preventClose">
    <!-- 关闭按钮 -->
    <view class="close-btn" bindtap="hideShareModal">✕</view>
    
    <!-- 标题 -->
    <view class="share-title">分享朋友圈 获得更多奖励</view>
    
    <!-- 分享图片 -->
    <view class="share-image-container">
      <!-- 如果有中奖图片，优先使用中奖图片 -->
      <image class="share-image" 
             src="{{winResult && winResult.image ? winResult.image : '/images/success.svg'}}" 
             mode="aspectFit" 
             wx:if="{{winResult && winResult.image}}"></image>
      
      <!-- 如果没有中奖图片，显示默认分享内容 -->
      <block wx:else>
        <image class="share-image" src="/images/success.svg" mode="aspectFit"></image>
        <!-- 如果没有图片，显示默认内容 -->
        <view class="share-preview">
          <view class="preview-header">🎉 异企趣玩抽奖</view>
          <view class="preview-amount">¥{{paymentAmount}}</view>
          <view class="preview-text">我刚参与了抽奖活动</view>
          <view class="preview-text">快来一起试试运气吧！</view>
          <view class="preview-footer">长按识别小程序码参与</view>
        </view>
      </block>
    </view>
    
    <!-- 分享文案 -->
    <view class="share-description">
      <text class="share-desc-title">📱 分享步骤：</text>
      <text class="share-desc-text">1. 长按保存上方图片到相册</text>
      <text class="share-desc-text">2. 打开微信朋友圈，选择刚保存的图片</text>
      <text class="share-desc-text">3. 配上文字发布，即可获得额外奖励机会</text>
    </view>
    
    <!-- 推荐文案 -->
    <view class="recommend-text">
      <text class="recommend-title">💡 推荐文案：</text>
      <text class="recommend-content">🎊刚参与了异企趣玩抽奖活动，支付¥{{paymentAmount}}就有机会获得大奖！运气不错的话说不定能中大奖呢～有兴趣的朋友可以一起来试试！</text>
      <button class="copy-text-btn" bindtap="copyRecommendText">一键复制文案</button>
    </view>
    
    <!-- 操作按钮 -->
    <view class="share-actions">
      <button class="save-image-btn" bindtap="saveShareImage">保存图片</button>
      <button class="goto-moments-btn" bindtap="gotoMoments">去朋友圈</button>
    </view>
  </view>
</view>

<!-- 全屏分享引导 -->
<view class="fullscreen-share-guide {{showFullScreenGuide ? 'show' : ''}}" bindtap="closeFullScreenGuide">
  <view class="fullscreen-guide-content" catchtap="preventClose">
    <!-- 顶部安全区域占位 -->
    <view class="safe-area-top"></view>
    
    <!-- 背景装饰 -->
    <view class="guide-bg-decoration"></view>
    
    <!-- 关闭按钮 -->
    <view class="guide-close-btn" bindtap="closeFullScreenGuide">✕</view>
    
    <!-- 主标题 -->
    <view class="guide-main-title">
      <block wx:if="{{winResult}}">🎉 恭喜中奖！</block>
      <block wx:else>🎊 分享朋友圈</block>
    </view>
    <view class="guide-sub-title">
      <block wx:if="{{winResult}}">分享朋友圈 让更多人看到你的好运气</block>
      <block wx:else>分享支付成功 获得更多奖励机会</block>
    </view>
    
    <!-- 分享媒体内容展示 -->
    <view class="guide-media-preview" wx:if="{{shareContent && shareContent.has_share_content && shareContent.share_media_url}}">
      <view class="media-label">📱 分享内容预览</view>
      <view class="media-container">
        <!-- 加载状态 -->
        <view class="media-loading" wx:if="{{mediaLoading}}">
          <view class="loading-spinner"></view>
          <text class="loading-text">加载中...</text>
          <!-- 调试信息 -->
          <text class="debug-info" style="font-size: 20rpx; color: #999; margin-top: 10rpx;">
            视频URL: {{shareContent.share_media_url}}
          </text>
          <!-- 超时后显示直接播放按钮 -->
          <button class="force-show-video" bindtap="forceShowVideo" style="margin-top: 20rpx; font-size: 24rpx;">
            直接播放视频
          </button>
        </view>
        
        <!-- 视频播放器 -->
        <!-- 仅在全屏分享引导显示时才加载视频，避免影响抽奖页面与网络压力 -->
        <block wx:if="{{shareContent.media_type === 'video' && showFullScreenGuide}}">
          <video 
            id="shareVideo"
            class="share-video"
            src="{{shareContent.share_media_url}}" 
            controls 
            autoplay="{{showFullScreenGuide}}"
            loop="{{true}}"
            muted="{{videoMuted}}"
            show-center-play-btn="{{true}}"
            show-play-btn="{{true}}"
            show-fullscreen-btn="{{false}}"
            show-progress="{{true}}"
            enable-progress-gesture="{{true}}"
            object-fit="contain"
            poster=""
            binderror="onVideoError"
            bindloadstart="onVideoLoadStart"
            bindloadedmetadata="onVideoLoad"
            bindcanplay="onVideoCanPlay"
            bindwaiting="onVideoWaiting"
            bindtimeupdate="onVideoTimeUpdate"
            bindplay="onVideoPlay"
            bindpause="onVideoPause"
          ></video>
          <view class="media-type-tag">🎬 视频 (弹窗时自动播放)</view>
          <!-- 视频控制按钮 -->
          <view class="video-controls" style="display: flex; gap: 10rpx; margin-top: 10rpx; justify-content: center;">
            <button class="video-control-btn" bindtap="playShareVideo" 
                    style="font-size: 24rpx; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 20rpx; padding: 8rpx 16rpx;">
              ▶️ 播放
            </button>
            <button class="video-control-btn" bindtap="toggleVideoMute" 
                    style="font-size: 24rpx; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 20rpx; padding: 8rpx 16rpx;">
              {{videoMuted ? '🔊 开声' : '🔇 静音'}}
            </button>
          </view>
        </block>
        
        <!-- 图片展示 -->
        <block wx:else>
          <image 
            class="share-image-media" 
            src="{{shareContent.media_type === 'video' ? '/images/success.svg' : shareContent.share_media_url}}" 
            mode="aspectFit"
            lazy-load="{{true}}"
            binderror="onImageError"
            bindload="onImageLoad"
          ></image>
          <view class="media-type-tag">📷 图片</view>
        </block>
      </view>
      <view class="media-desc">这是朋友们在朋友圈看到的内容</view>
    </view>
    
    <!-- 分享步骤 -->
    <view class="guide-steps">
      <view class="guide-step">
        <view class="step-number">1</view>
        <view class="step-content">
          <view class="step-title">点击右上角 ••• 按钮</view>
          <view class="step-desc">点击页面右上角的三个点按钮</view>
        </view>
        <view class="step-arrow">→</view>
      </view>
      
      <view class="guide-step">
        <view class="step-number">2</view>
        <view class="step-content">
          <view class="step-title">选择"分享到朋友圈"</view>
          <view class="step-desc">在弹出的菜单中选择分享到朋友圈</view>
        </view>
        <view class="step-arrow">→</view>
      </view>
      
      <view class="guide-step">
        <view class="step-number">3</view>
        <view class="step-content">
          <view class="step-title">添加文字发布</view>
          <view class="step-desc">配上推荐文案，让朋友们看到你的好运气</view>
        </view>
      </view>
    </view>
    
    <!-- 右上角箭头指示 -->
    <view class="top-right-indicator">
      <view class="indicator-arrow">↗</view>
      <view class="indicator-text">点击这里分享</view>
    </view>
    
    <!-- 推荐文案 -->
    <view class="guide-recommend-text">
      <view class="recommend-label">💡 推荐文案</view>
      <view class="recommend-content">
        <!-- 优先使用后台API返回的推荐文案 -->
        <block wx:if="{{shareContent && shareContent.recommend_text}}">
          {{shareContent.recommend_text}}
        </block>
        <!-- 如果后台API有分享标题但没有推荐文案，使用分享标题 -->
        <block wx:elif="{{shareContent && shareContent.share_title}}">
          {{shareContent.share_title}}
        </block>
        <!-- 如果后台API有分享文案但没有推荐文案和标题，使用分享文案 -->
        <block wx:elif="{{shareContent && shareContent.share_text}}">
          {{shareContent.share_text}}
        </block>
        <!-- 回退到默认文案 -->
        <block wx:elif="{{winResult && (winResult.prize_name || winResult.prize_info.name)}}">
          🎊刚参与了异企趣玩抽奖活动，支付¥{{paymentAmount}}就有机会获得大奖！我竟然中了{{winResult.prize_name || winResult.prize_info.name}}！运气不错的话说不定你也能中大奖呢～有兴趣的朋友可以一起来试试！
        </block>
        <block wx:else>
          🎊刚参与了异企趣玩抽奖活动，支付¥{{paymentAmount}}就有机会获得大奖！快来一起试试运气吧！
        </block>
      </view>
    </view>
    
    <!-- 操作按钮 -->
    <view class="guide-actions">
      <button class="guide-share-btn" bindtap="triggerShare">立即分享到朋友圈</button>
      <button class="guide-copy-btn" bindtap="copyRecommendText">复制推荐文案</button>
      <button class="guide-done-btn" bindtap="closeFullScreenGuide">我知道了</button>
    </view>
  </view>
</view>

<!-- 抽奖loading全屏动画 -->
<view class="lottery-loading-modal {{showLotteryLoading ? 'show' : ''}}" catchtap="preventClose">
  <view class="lottery-loading-content">
    <!-- 抽奖loading动画 -->
    <view class="lottery-spinner">
      <view class="spinner-ring"></view>
      <view class="spinner-ring"></view>
      <view class="spinner-ring"></view>
    </view>
    
    <!-- 抽奖文字提示 -->
    <view class="lottery-loading-text">
      <view class="loading-title">🎊✨正在抽奖中...</view>
      <view class="loading-subtitle">请稍候，好运即将揭晓</view>
    </view>
  </view>
</view>
