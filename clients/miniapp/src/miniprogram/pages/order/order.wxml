<!-- order.wxml -->
<navigation-bar title="è®¢å•è®°å½•" back="{{true}}" color="black" background="white"></navigation-bar>

<view class="order-container">
  
  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view class="login-required" wx:if="{{needLogin}}">
    <view class="login-icon">ğŸ”</view>
    <view class="login-title">è¯·å…ˆç™»å½•</view>
    <view class="login-desc">ç™»å½•åå³å¯æŸ¥çœ‹æ‚¨çš„è®¢å•è®°å½•</view>
    <view class="login-buttons">
      <button class="login-btn primary" bindtap="handleLogin">ç«‹å³ç™»å½•</button>
    </view>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ - æ˜¾ç¤ºè®¢å•å†…å®¹ -->
  <view wx:else>
    <!-- ç­›é€‰æ ‡ç­¾æ  -->
    <view class="filter-tabs">
      <view 
        class="filter-tab {{currentFilter === item.key ? 'active' : ''}}"
        wx:for="{{filterOptions}}" 
        wx:key="key"
        wx:for-item="item"
        data-filter="{{item.key}}"
        bindtap="switchFilter">
        <text class="tab-name">{{item.name}}</text>
        <text class="tab-count" wx:if="{{item.count > 0}}">({{item.count}})</text>
      </view>
    </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <scroll-view 
    class="order-list"
    scroll-y="{{true}}"
    enable-back-to-top="{{true}}">
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-wrapper" wx:if="{{isEmpty && !loading}}">
      <view class="empty-icon">ğŸ“‹</view>
      <view class="empty-text">æš‚æ— è®¢å•è®°å½•</view>
      <view class="empty-tip">å¿«å»é¦–é¡µå‚ä¸æŠ½å¥–å§~</view>
      <navigator url="/pages/index/index" open-type="switchTab">
        <button class="go-lottery-btn">ç«‹å³æŠ½å¥–</button>
      </navigator>
    </view>

    <!-- è®¢å•åˆ—è¡¨é¡¹ -->
    <view class="order-item" wx:for="{{orderList}}" wx:key="orderId" wx:for-item="orderItem" wx:for-index="index" data-index="{{index}}" bindtap="showOrderDetail">
      <!-- è®¢å•å¤´éƒ¨ -->
      <view class="order-header">
        <view class="order-info">
          <text class="order-id">è®¢å•å·: {{orderItem.orderId}}</text>
          <text class="order-time">{{orderItem.createTime}}</text>
        </view>
        <view class="order-status status-{{orderItem.status}}">
          {{orderItem.order_status === 4 ? 'é€€æ¬¾æˆåŠŸ' :
            (orderItem.order_status === 3 ? 'å·²å–æ¶ˆè®¢å•' :
              (orderItem.pay_status === 'paid' ? 
                (orderItem.order_status === 2 ? 'å·²å®Œæˆ' : 
                  (orderItem.order_status === 1 ? 
                    (orderItem.lotteryResult === 'winner' ? 'å·²ä¸­å¥–' : 'å¾…æŠ½å¥–') : 'å·²æ”¯ä»˜')) 
                : 'å¾…æ”¯ä»˜'))}}
        </view>
      </view>

      <!-- è®¢å•å†…å®¹ -->
      <view class="order-content">
        <view class="order-left">
          <view class="lottery-icon">ğŸ°</view>
        </view>
        <view class="order-middle">
          <text class="product-name">æŠ½å¥–æœºä¼š</text>
          <text class="product-desc">æ”¯ä»˜å³å¯è·å¾—ä¸€æ¬¡æŠ½å¥–æœºä¼š</text>
          <view class="prize-result" wx:if="{{orderItem.pay_status === 'paid' && orderItem.lotteryResult === 'winner'}}">
            <text class="result-text">
              ä¸­å¥–ï¼š{{orderItem.prizeName}}
            </text>
          </view>
          <!-- è®¾å¤‡ä¸å¥–å“æ ‡è¯†ä¿¡æ¯ -->
          <view class="order-meta">
            <text class="meta-item" wx:if="{{orderItem.device_id}}">è®¾å¤‡IDï¼š{{orderItem.device_id}}</text>
            <text class="meta-item" wx:if="{{orderItem.prize_id && orderItem.prize_id > 0}}">å¥–å“IDï¼š{{orderItem.prize_id}}</text>
          </view>
        </view>
        <view class="order-right">
          <text class="amount">Â¥{{orderItem.amount}}</text>
        </view>
      </view>

      <!-- è®¢å•æ“ä½œæŒ‰é’® -->
      <view class="order-actions" catchtap="stopPropagation">
        <!-- å·²å–æ¶ˆè®¢å•ï¼šåªæ˜¾ç¤ºå¤åˆ¶è®¢å•å·æŒ‰é’® -->
        <view wx:if="{{orderItem.order_status === 3}}" class="action-buttons">
          <view>
            <button class="action-btn secondary" data-orderid="{{orderItem.orderId}}" bindtap="copyOrderId" size="mini">å¤åˆ¶è®¢å•å·</button>
          </view>
        </view>
        
        <!-- å·²æ”¯ä»˜ä½†æœªå®Œæˆçš„çŠ¶æ€æ“ä½œï¼ˆæ’é™¤å·²å–æ¶ˆçŠ¶æ€ï¼‰ -->
        <view wx:elif="{{orderItem.pay_status === 'paid' && orderItem.order_status !== 2 && orderItem.order_status !== 3}}" class="action-buttons">
          <!-- å¦‚æœå·²æ”¯ä»˜ä¸”order_statusä¸º0æˆ–1ï¼Œæ˜¾ç¤ºæŠ½å¥–å’Œé€€æ¬¾æŒ‰é’® -->
          <view wx:if="{{orderItem.order_status === 0 || orderItem.order_status === 1}}" class="pending-actions">
            <!-- å¦‚æœæ²¡æœ‰æŠ½å¥–ç»“æœï¼Œæ˜¾ç¤ºç«‹å³æŠ½å¥–æŒ‰é’® -->
            <button wx:if="{{!orderItem.lotteryResult || orderItem.lotteryResult === '' || orderItem.lotteryResult === null || orderItem.lotteryResult === undefined}}" class="action-btn primary" data-index="{{index}}" bindtap="goToLottery" size="mini">ç«‹å³æŠ½å¥–</button>
            <!-- å¦‚æœå·²ä¸­å¥–ï¼Œæ˜¾ç¤ºæ ¸é”€æŒ‰é’® -->
            <button wx:elif="{{orderItem.lotteryResult === 'winner' && orderItem.can_verify}}" class="action-btn primary" data-index="{{index}}" bindtap="verifyPrize" size="mini">æ ¸é”€å¥–å“</button>
            <button wx:elif="{{orderItem.lotteryResult === 'winner' && orderItem.can_verify}}" class="action-btn secondary" data-index="{{index}}" bindtap="scanVerify" size="mini">æ‰«ç æ ¸é”€</button>
            <!-- å¤åˆ¶è®¢å•å·æŒ‰é’®æ”¾åœ¨ä¸­é—´ä½ç½® -->
            <button class="action-btn secondary" data-orderid="{{orderItem.orderId}}" bindtap="copyOrderId" size="mini">å¤åˆ¶è®¢å•å·</button>
            <!-- é€€æ¬¾æŒ‰é’®æ”¾åœ¨æœ€åï¼ˆå¦‚æœå…è®¸ï¼‰ -->
            <button wx:if="{{orderItem.can_refund}}" class="action-btn secondary" data-index="{{index}}" bindtap="requestRefund" size="mini">ç”³è¯·é€€æ¬¾</button>
          </view>
          <!-- å…¶ä»–å·²æ”¯ä»˜çŠ¶æ€çš„æŒ‰é’® -->
          <view wx:else>
            <button wx:if="{{orderItem.can_refund}}" class="action-btn secondary" data-index="{{index}}" bindtap="requestRefund" size="mini">ç”³è¯·é€€æ¬¾</button>
            <button wx:if="{{orderItem.can_verify && orderItem.lotteryResult === 'winner'}}" class="action-btn primary" data-index="{{index}}" bindtap="verifyPrize" size="mini">æ ¸é”€å¥–å“</button>
            <button wx:if="{{orderItem.can_verify && orderItem.lotteryResult === 'winner'}}" class="action-btn secondary" data-index="{{index}}" bindtap="scanVerify" size="mini">æ‰«ç æ ¸é”€</button>
            <!-- å¤åˆ¶è®¢å•å·æŒ‰é’® -->
            <button class="action-btn secondary" data-orderid="{{orderItem.orderId}}" bindtap="copyOrderId" size="mini">å¤åˆ¶è®¢å•å·</button>
          </view>
        </view>
        
        <!-- å·²å®ŒæˆçŠ¶æ€çš„æ“ä½œ -->
        <view wx:elif="{{orderItem.pay_status === 'paid' && orderItem.order_status === 2}}" class="action-buttons">
          <button class="action-btn secondary" data-orderid="{{orderItem.orderId}}" bindtap="copyOrderId" size="mini">å¤åˆ¶è®¢å•å·</button>
          <button wx:if="{{orderItem.verification_code && orderItem.lotteryResult === 'winner'}}" class="action-btn primary" data-code="{{orderItem.verification_code}}" bindtap="copyVerificationCode" size="mini">å¤åˆ¶æ ¸é”€ç </button>
          <button wx:if="{{orderItem.verification_code && orderItem.lotteryResult === 'winner'}}" class="action-btn secondary" data-code="{{orderItem.verification_code}}" bindtap="showVerificationQr" size="mini">æ ¸é”€äºŒç»´ç </button>
        </view>
        
        <!-- å¾…æ”¯ä»˜çŠ¶æ€çš„æ“ä½œ -->
        <view wx:else class="action-buttons">
          <!-- å¦‚æœæ˜¯å¾…æ”¯ä»˜çŠ¶æ€ï¼ˆorder_status === 0ï¼‰ï¼Œæ˜¾ç¤ºç»§ç»­æ”¯ä»˜å’Œå–æ¶ˆè®¢å•æŒ‰é’® -->
          <view wx:if="{{orderItem.order_status === 0}}" class="pending-actions">
            <button class="action-btn primary" data-index="{{index}}" bindtap="continuePay" size="mini">ç»§ç»­æ”¯ä»˜</button>
            <button class="action-btn secondary" data-orderid="{{orderItem.orderId}}" bindtap="copyOrderId" size="mini">å¤åˆ¶è®¢å•å·</button>
            <button class="action-btn secondary" data-index="{{index}}" bindtap="cancelOrder" size="mini">å–æ¶ˆè®¢å•</button>
          </view>
          <!-- å…¶ä»–çŠ¶æ€åªæ˜¾ç¤ºå¤åˆ¶è®¢å•å· -->
          <view wx:else>
            <button class="action-btn secondary" data-orderid="{{orderItem.orderId}}" bindtap="copyOrderId" size="mini">å¤åˆ¶è®¢å•å·</button>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>
</view>

<!-- è®¢å•è¯¦æƒ…å¼¹çª— -->
<view class="order-detail-mask" wx:if="{{showOrderDetail}}" bindtap="closeOrderDetail">
  <view class="order-detail-popup" catchtap="stopPropagation">
    <view class="detail-header">
      <view class="back-btn" bindtap="closeOrderDetail">â† è¿”å›</view>
      <text class="detail-title">è®¢å•è¯¦æƒ…</text>
      <view class="close-btn" bindtap="closeOrderDetail">âœ•</view>
    </view>
    
    <view class="detail-content" wx:if="{{currentOrder}}">
      <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="info-row">
          <text class="info-label">è®¢å•å·</text>
          <text class="info-value">{{currentOrder.orderId}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">è®¢å•é‡‘é¢</text>
          <text class="info-value">Â¥{{currentOrder.amount}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">åˆ›å»ºæ—¶é—´</text>
          <text class="info-value">{{currentOrder.createTime}}</text>
        </view>
        <view class="info-row" wx:if="{{currentOrder.device_id}}">
          <text class="info-label">è®¾å¤‡ID</text>
          <text class="info-value">{{currentOrder.device_id}}</text>
        </view>
        <view class="info-row" wx:if="{{currentOrder.prize_id && currentOrder.prize_id > 0}}">
          <text class="info-label">å¥–å“ID</text>
          <text class="info-value">{{currentOrder.prize_id}}</text>
        </view>
      </view>

      <!-- æŠ½å¥–ç»“æœ -->
      <view class="detail-section" wx:if="{{currentOrder.pay_status === 'paid' && (currentOrder.lotteryResult === 'winner' || currentOrder.lotteryResult === 'no_prize' || currentOrder.prizeName || currentOrder.verification_code)}}">
        <view class="section-title">æŠ½å¥–ç»“æœ</view>
        
        <!-- ä¸­å¥–ä¿¡æ¯ -->
        <view wx:if="{{currentOrder.lotteryResult === 'winner' || (currentOrder.prizeName && currentOrder.prizeName !== '')}}" class="winner-result-section">
          <!-- å¥–å“å›¾ç‰‡ -->
          <view class="detail-prize-image-section" wx:if="{{currentOrder.prizeImage && currentOrder.prizeImage !== '' && currentOrder.prizeImage !== null && currentOrder.prizeImage !== 'null'}}">
            <image class="detail-prize-image" src="{{currentOrder.prizeImage}}" mode="aspectFit" binderror="handleImageError"></image>
          </view>
          
          <view class="lottery-result-card">
            <view class="result-icon">ğŸ‰</view>
            <view class="result-content">
              <text class="result-title">{{currentOrder.prizeName}}</text>
              <text class="result-desc" wx:if="{{currentOrder.prizeDesc}}">{{currentOrder.prizeDesc}}</text>
            </view>
          </view>
          
          <!-- æ ¸é”€ç ä¿¡æ¯ -->
          <view class="detail-verification-section" wx:if="{{currentOrder.verification_code}}">
            <view class="verification-title">æ ¸é”€ç </view>
            <view class="verification-code-display">{{currentOrder.verification_code}}</view>
            <button class="detail-copy-code-btn" data-code="{{currentOrder.verification_code}}" bindtap="copyVerificationCode" size="mini">å¤åˆ¶æ ¸é”€ç </button>
            <button class="detail-copy-code-btn secondary" data-code="{{currentOrder.verification_code}}" bindtap="showVerificationQr" size="mini">æ˜¾ç¤ºäºŒç»´ç </button>
          </view>
        </view>
        
        <!-- æœªä¸­å¥–ä¿¡æ¯ -->
        <view wx:elif="{{currentOrder.lotteryResult === 'no_prize'}}" class="lottery-result-card">
          <view class="result-icon">ğŸ¯</view>
          <view class="result-content">
            <text class="result-title">{{currentOrder.prizeName || 'å¾ˆé—æ†¾ï¼Œæœªä¸­å¥–'}}</text>
            <text class="result-desc">{{currentOrder.prizeDesc || 'è°¢è°¢å‚ä¸ï¼Œå†æ¥å†å‰'}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="detail-actions">
      <button class="detail-action-btn secondary" data-orderid="{{currentOrder.orderId}}" bindtap="copyOrderId">å¤åˆ¶è®¢å•å·</button>
      <!-- åªæœ‰å·²æ”¯ä»˜ä¸”éå–æ¶ˆã€éé€€æ¬¾çŠ¶æ€çš„ä¸­å¥–è®¢å•æ‰æ˜¾ç¤ºå¤åˆ¶æ ¸é”€ç æŒ‰é’® -->
      <button wx:if="{{currentOrder.pay_status === 'paid' && currentOrder.order_status !== 3 && currentOrder.order_status !== 4 && currentOrder.verification_code && (currentOrder.lotteryResult === 'winner' || currentOrder.prizeName)}}" class="detail-action-btn primary" data-code="{{currentOrder.verification_code}}" bindtap="copyVerificationCode">å¤åˆ¶æ ¸é”€ç </button>
      <button wx:if="{{currentOrder.pay_status === 'paid' && currentOrder.order_status !== 3 && currentOrder.order_status !== 4 && currentOrder.verification_code && (currentOrder.lotteryResult === 'winner' || currentOrder.prizeName)}}" class="detail-action-btn secondary" data-code="{{currentOrder.verification_code}}" bindtap="showVerificationQr">æ ¸é”€äºŒç»´ç </button>
      <!--button class="detail-action-btn primary" bindtap="contactService">è”ç³»å®¢æœ</button-->
    </view>
  </view>
  
  </view> <!-- å·²ç™»å½•çŠ¶æ€ç»“æŸ -->
</view>

<!-- å®¢æœè”ç³»å¼¹çª— -->
<view class="service-modal-mask" wx:if="{{showServiceModal}}" bindtap="closeServiceModal">
  <view class="service-modal-popup" catchtap="stopPropagation">
    <view class="service-header">
      <text class="service-title">è”ç³»å®¢æœ</text>
      <view class="close-btn" bindtap="closeServiceModal">âœ•</view>
    </view>
    
    <view class="service-content">
      <view class="service-section">
        <view class="service-item" bindtap="copyWechatNumber">
          <view class="service-icon wechat-icon">ğŸ’š</view>
          <view class="service-info">
            <text class="service-name">å¾®ä¿¡å®¢æœ</text>
            <text class="service-number">service_wechat</text>
          </view>
          <view class="service-action">å¤åˆ¶</view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å¥–å“ä¿¡æ¯å¼¹çª— -->
<view class="prize-modal-mask" wx:if="{{showPrizeModal}}" bindtap="closePrizeModal">
  <view class="prize-modal-popup" catchtap="stopPropagation">
    <view class="prize-header">
      <text class="prize-title">ğŸ‰ ä¸­å¥–ä¿¡æ¯</text>
      <view class="close-btn" bindtap="closePrizeModal">âœ•</view>
    </view>
    
    <view class="prize-content" wx:if="{{currentPrizeOrder}}">
      <!-- å¥–å“å›¾ç‰‡ -->
      <view class="prize-image-section" wx:if="{{currentPrizeOrder.prizeImage && currentPrizeOrder.prizeImage !== '' && currentPrizeOrder.prizeImage !== null && currentPrizeOrder.prizeImage !== 'null'}}">
        <image class="prize-image" src="{{currentPrizeOrder.prizeImage}}" mode="aspectFit" binderror="handleImageError"></image>
      </view>
      
      <!-- å¥–å“ä¿¡æ¯ -->
      <view class="prize-info-section">
        <view class="prize-name">{{currentPrizeOrder.prizeName}}</view>
        <view class="prize-desc" wx:if="{{currentPrizeOrder.prizeDesc}}">{{currentPrizeOrder.prizeDesc}}</view>
        
        <!-- æ ¸é”€ç  -->
        <view class="verification-section">
          <view class="verification-label">æ ¸é”€ç </view>
          <view class="verification-code">{{currentPrizeOrder.verification_code}}</view>
          <button class="copy-code-btn" data-code="{{currentPrizeOrder.verification_code}}" bindtap="copyVerificationCode" size="mini">å¤åˆ¶</button>
          <button class="copy-code-btn secondary" data-code="{{currentPrizeOrder.verification_code}}" bindtap="showVerificationQr" size="mini">äºŒç»´ç </button>
        </view>
      </view>
    </view>
    
    <view class="prize-actions">
      <button class="prize-action-btn" bindtap="closePrizeModal">å…³é—­</button>
    </view>
  </view>
</view>

<!-- äºŒç»´ç å¼¹çª— -->
<view class="qr-modal-mask" wx:if="{{showQrModal}}" bindtap="closeQrModal">
  <view class="qr-modal-popup" catchtap="stopPropagation">
    <view class="qr-header">
      <text class="qr-title">æ ¸é”€ç äºŒç»´ç </text>
      <view class="close-btn" bindtap="closeQrModal">âœ•</view>
    </view>
    <view class="qr-content">
      <view wx:if="{{qrLoading}}" class="qr-loading">æ­£åœ¨ç”Ÿæˆ...</view>
      <image wx:elif="{{qrImageUrl}}" class="qr-image" src="{{qrImageUrl}}" mode="aspectFit" show-menu-by-longpress="true"></image>
      <view wx:else class="qr-error">äºŒç»´ç ç”Ÿæˆå¤±è´¥</view>
      <view class="qr-tip">é•¿æŒ‰äºŒç»´ç å¯ä¿å­˜æˆ–è¯†åˆ«</view>
    </view>
  </view>
</view>
