# 牛商城 V5｜幸运抽奖全链路交接视图（当前实现+可商用指引）

本文面向外包实施团队，基于当前代码与数据库配置，给出“可见视图+可落地方案”。按图走即可完成商用交付。

## 1）一图总览（系统组件与数据流）

┌──────────────────────────────┐
│            用户端（小程序 / APP / H5）            │
│  扫码进入 → 下单支付 → 动画展示 → 查看结果/核销      │
└──────────────┬──────────────┘
               │HTTP/WS
               ▼
┌──────────────────────────────┐
│         Node WebSocket 服务（websocket/）        │
│  • 管设备连接与房间 • 接收后端 start_lottery 指令    │
│  • 接收设备抽奖结果 lottery_result                │
│  • 回调后端 POST /api/lottery/result（带签名）       │
└──────────────┬──────────────┘
               │HTTP
               ▼
┌──────────────────────────────┐
│            牛商城 V5 后端（ThinkPHP）            │
│  模块：抽奖盘/奖品/价档/设备/订单/核销/分润/日志       │
│  关键接口：                                      │
│  • /api/lottery/result  ← 设备结果回调（签名/幂等）    │
│  • /api/lottery/verify  ← 核销确认（计划增强为事务）    │
│  • /api/lottery/distribute ← 分润结算（示例实现）       │
│  • /addons/turntable/api/prize-list / record      │
│  核心动作：落库 lottery_record → 原子扣减库存 → 核销码 │
└──────────────┬──────────────┘
               │SQL/缓存
               ▼
┌──────────────────────────────┐
│           MySQL（niushop @127.0.0.1:3307）       │
│  • device_info / device_price_bind               │
│  • device_probability_grid（inventory_current）   │
│  • lottery_record / ns_lottery_profit            │
│  • lottery_board / lottery_slot（管理面）         │
└──────────────────────────────┘

运行参数：
- WebSocket：WS_PORT=3003，API_BASE_URL=http://127.0.0.1:9100/index.php/api
- 回调签名：可选密钥 `SOCKET_CALLBACK_SECRET`（开启后要求签名+180s时效）

## 2）端到端时序（从下单到分润）

1. 创建订单 → 支付成功（商城原生支付流）。
2. 后端触发设备抽奖（WS 指令 start_lottery）。
3. 设备完成抽奖 → 通过 WS 向 Node 上报 `lottery_result`。
4. Node 服务器组装结果并 HTTP 回调 `POST /api/lottery/result`，携带：
   - device_id / grid_no / result / ts / sign；可含 prize_info、order_id、amount。
5. 后端 `Lottery::result()` 校验：
   - 时间戳±180s；若配置了 `SOCKET_CALLBACK_SECRET` 则校验 HMAC-SHA256 签名。
   - 设备有效性、参数完整性。
6. 业务入库：
   - 构建 `lottery_record`（含 member_id/device_id/slot_id/result/order_id 等）。
   - 若带 `lottery_record_id` 则更新，否则插入新记录（与 WS 本地记录对齐）。
   - 原子扣减库存：`device_probability_grid.inventory_current` 在“命中且可扣”条件下 `inventory_current = inventory_current - 1`（where inventory_current >= 1），并回写快照 `inv_snapshot` 到记录。
7. 生成核销态：
   - 命中实物：创建/补充订单信息（0元单或绑定外部单），标记 `refund_lock=1`（防止已中/已核销退款）。
8. 核销：`/api/lottery/verify` 或扫码入口 `scan()`（现已路由到 verify）。
   - 建议增强为“强一致事务+行级锁”，确保一次核销只结一次账。
9. 分润：
   - 示例接口 `/api/lottery/distribute`：按订单金额拆分平台/商家至 `ns_lottery_profit`（示例结构，生产需替换为“价档定额模板”）。
   - 已做幂等拦截（同一 record / order 重复不新增）。

异常与幂等：
- 回调失败统一记录日志；重复回调通过幂等校验阻止重复分润；`lottery_record` 侧优先按传入 record_id 更新。

## 3）接口契约（当前代码）

- 设备结果回调：`POST /api/lottery/result`
  - 入参：`device_id`、`grid_no`、`result(win|lose|miss)`、`ts`、`sign`、可选：`prize_id/prize_name/order_id/amount/lottery_record_id`
  - 校验：时间戳±180s；若设置 `SOCKET_CALLBACK_SECRET` 则 `sign=HMAC_SHA256(payload, SECRET)`。
  - 出参：`{ code, data:{ record_id, result, order_id }, message }`

- 核销：`POST /api/lottery/verify`（或 `scan()` 同路由）
  - 入参：记录/订单/核销码等（与现有核销模块对齐）。
  - 待增强：开启事务，锁定相关记录行，写核销与分润，全部成功才提交。

- 分润发放（示例）：`POST /api/lottery/distribute`
  - 入参：`order_id`
  - 动作：查询 `lottery_record` 汇总金额 → 写 `ns_lottery_profit`（平台/商家示例）。
  - 商用要求：改为按“价档定额模板”精确落账；并做幂等+事务。

- 16格管理（addon.turntable）：
  - `GET /addons/turntable/api/prize-list` 拉奖品格子
  - `GET /addons/turntable/api/record` 抽奖记录分页

## 4）核心表与字段（上线必读）

- `device_info`：设备主数据（device_id/device_sn/site_id/board_id/...）。
- `device_price_bind`：设备绑定价档（含生效期/状态）。
- `lottery_price_tier`：价档与分润模板（示例字段 `profit_json`）。
- `device_probability_grid`：每设备16格库存/权重
  - `inventory_override`（配置量）、`inventory_current`（当前量，生产用此原子扣减）。
  - 索引建议：(`device_id`,`grid_no`)、(`device_id`,`grid_no`,`inventory_current`).
- `lottery_record`：抽奖记录
  - 关键字段：member_id, device_id, slot_id, result(hit|miss), order_id, amount, round_no, inv_snapshot(JSON), ext(JSON), create_time。
- `ns_lottery_profit`：分润明细（示例：order_id, record_id, role, target_id, amount, status, settle_time）。
- （管理面）`lottery_board`/`lottery_slot`：盘与16格配置。

库存迁移要点：
- 已将扣减逻辑从 `device_info.prob_json` 迁移为表 `device_probability_grid.inventory_current` 的“结构化原子更新”。
- 新部署务必初始化：`inventory_current = inventory_override`（一次性），并建立辅助索引。

SQL 参考（若尚未执行迁移）：
```sql
ALTER TABLE device_probability_grid ADD COLUMN inventory_current INT NOT NULL DEFAULT 0 AFTER inventory_override;
UPDATE device_probability_grid SET inventory_current = inventory_override WHERE inventory_current = 0;
CREATE INDEX idx_device_grid_invcur ON device_probability_grid(device_id, grid_no, inventory_current);
```

## 5）运行与部署

- 数据库：MySQL（niushop），默认连接 `127.0.0.1:3307`，库名 `niushop`（见 config/database.php）。
- PHP 后端（开发态）：`php -S 127.0.0.1:9100 -t public public/router.php`
- Node WS：在 `websocket/` 目录运行 `server_new.js`，环境变量示例：
  ```powershell
  $env:WS_PORT=3003; $env:API_BASE_URL='http://127.0.0.1:9100/index.php/api'; $env:ENV_MODE='local'; $env:FORCE_DEVICE_REGISTER='true'
  node server_new.js
  ```
- 回调签名：如需开启，将密钥写入运行环境 `SOCKET_CALLBACK_SECRET`。

## 6）验收用例（外包必过）

- 16格列表展示正确；设备与盘/价档绑定生效。
- 支付→start_lottery→设备结果→/api/lottery/result 入库成功。
- 命中记录写入 `lottery_record`，并对目标格完成“原子扣减”，无负库存与超发。
- 重复回调不新增分润记录（幂等生效）。
- 核销一次成功、重复核销被拦截（待事务增强版）。
- 分润金额与价档模板一致，写入 `ns_lottery_profit`。

## 7）增强与边界（建议纳入本次商用）

- 核销强一致事务：`verify()` 内对 `lottery_record`/订单/分润表加行级锁，统一提交。
- 分润模板落地：按 `lottery_price_tier.profit_json` 定额拆账，失败回滚。
- 风控：同用户/设备频控、IP 限制、设备白名单；回调签名默认开启。
- 观测：关键路径日志 + 告警（回调失败、库存异常、事务回滚）。

—— 以上为“当前实现 + 可商用落地”的交接视图。外包按图搭建与对齐接口/表结构，即可完成上线交付。