总体路径

抽奖主流程：用户前端获取抽奖盘 → 支付或直接抽取 → 命中生成记录 → 到店核销或填写地址 → 分润/结算入账。
三端协同：后台配置好盘/设备/价档；用户端按接口对接；设备端可选走 WebSocket 回调或纯后端抽取。
后端代码与接口

核心控制器
addon/turntable/api/controller/Turntable.php：GET /info、GET /prizeList、POST /draw、POST /address、POST /verify、GET /record
addon/turntable/admin/controller/Turntable.php：后台活动列表、添加、编辑、详情
addon/turntable/admin/controller/Bind.php：设备与价档绑定列表、添加、删除
核心模型
addon/turntable/model/Lottery.php：奖品列表、抽奖逻辑、并发与频控、价档识别、分润信息输出
结算事件
addon/turntable/event/TurntableSettlement.php：核销后入队 lottery_settlement 并幂等写 ns_lottery_profit
关键表
device_info、lottery_board、lottery_slot、lottery_record、device_price_bind、lottery_price_tier、ns_lottery_profit、lottery_settlement
后台端（平台/商家运营）

配置与管理
新建抽奖盘与格子：设置 prize_type/weight/inventory/round_qty，推荐开启“轮次模式”和自动重置。
奖品管理：实物绑定商品与 SKU，确保库存>0；虚拟奖直接发放。
价档管理：定义 price 与 profit_json（定额或比例，比例总和≤1）。
设备管理与价档绑定：在 Bind 中为每台设备绑定唯一“当前生效”的价档。
页面修复与一致性
视图中的模板语法不要写入 style（已修复若干处），统一用类（如 layui-hide）+ JS 控制显示。
上线准备
数据迁移与索引：确认库存字段与索引到位（见《交接_幸运抽奖全链路_落地视图.md》的 SQL 建议）。
环境变量与配置：数据库 .env 生效，cache 配置 Redis；如未配 Redis，会走降级锁但性能较弱。
日志与告警：结果回调失败、库存异常、事务回滚应记录并告警。
后台验收
活动列表展示与筛选；设备绑定价档仅一个当前生效；抽奖盘轮次重置生效；抽奖记录与核销记录一致。
用户端（小程序/H5/APP）

页面与流程
抽奖盘展示：调用 GET /addons/turntable/api/turntable/prizeList?site_id=&device_id|device_sn 展示 16 宫格。（返回含当前生效价档与 profit_info）
抽一次：POST /addons/turntable/api/turntable/draw，需用户登录态（Bearer Token）。接口已做“同用户同设备 3 秒”频控与并发锁。
命中实物后填写地址：POST /addons/turntable/api/turntable/address（必填姓名、手机、地址）。
到店核销：POST /addons/turntable/api/turntable/verify（用户端提供核销码，返回 status=verified）。
我的抽奖记录：GET /addons/turntable/api/turntable/record?page=&page_size=&device_id（未登录必须带 device_id 或返回空）。
接口契约
返回结构与示例已写入 docs/抽奖插件API接口.md，直接按文档对接。
验收要点
未登录不可拿公共记录；频控提示友好；实物奖命中后地址可写且与核销联动；“谢谢参与”不再返回到 16 格候选。
设备端（现场设备/WS 服务）

两种选择
纯后端抽取（推荐起步）：设备仅展示抽奖 UI，抽取由用户端调用 POST /draw 完成，省去 WS 回调与固件双向通信。
设备回调联动（进阶场景）：启用 Node WebSocket（websocket/server_new.js），设备上报抽奖结果，WS 回调后端接口（例如 /api/lottery/result，签名与时效要求在现有文档中）。
WS 联调要点（若启用）
环境变量：WS_PORT、API_BASE_URL、SOCKET_CALLBACK_SECRET；API 与签名窗口±180s。
设备注册、房间与指令：设备上线后按 SN 房间接收 start_lottery 指令，上报 lottery_result。
幂等与一致性：重复回调不新增分润；命中后做原子扣减库存并回写快照。
设备验收
心跳在线与房间联通；抽取过程不卡顿；结果与后端记录一致；核销后分润入账。
支付与订单

抽奖金额来源
插件侧以价档金额作为分润基准；命中实物金额为 0 时将用价档金额兜底参与结算（见 TurntableSettlement.php）。
订单联动
命中实物记录会写 ext.order.verify_code；核销后写 status=verified 并触发事件。
如需强一致，建议将核销改为事务（锁定记录/订单/分润），代码位于 addon/turntable/api/controller/Turntable.php::verify。
运维与安全

环境变量
数据库/缓存：.env 中 DB_HOST/DB_NAME/DB_USER/DB_PWD/DB_PORT；Redis 按 config/cache.php 配置。
回调签名：SOCKET_CALLBACK_SECRET（如启用 WS 设备回调）。
安全与风控
频控与并发锁已内置；生产建议加 IP 限制与设备白名单。
错误码与提示统一：语言包位于 app/api/lang/zh-cn（文档有示例）。
观测
接口慢查询与错误日志；回调失败重试策略；库存异常（负数/超发）报警。
三端上线清单（可执行）

后台端
配完盘与格子；完成设备与价档绑定；确认“默认生效价档”有效。
检查视图模板中 style 不再混入 {if} 等语法。
用户端
接好 prizeList/draw/address/verify/record 五个接口；登录与 Bearer Token 透传。
实物命中后表单校验；核销后状态刷新与提示。
设备端（如启用）
部署并配置 websocket/server_new.js；设备心跳与房间联通；签名校验通过。
支付与财务
价档金额与分润模板确认；分润入账到 ns_lottery_profit 幂等更新。
数据与监控
索引与迁移完成；日志与告警接入；备份与导出流程就绪（已有 export_db.php 与 upgrade.sql）。