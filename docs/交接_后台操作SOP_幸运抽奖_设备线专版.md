# 幸运抽奖后台操作SOP（设备抽奖线专版｜只讲线下设备）

适用对象：后台管理员、运营、实施、现场维护。
范围声明：本文仅覆盖“线下设备抽奖线”（抽奖盘/格子/设备/价档/分润/核销）。线上活动型抽奖（H5/会员中心，award_json）不在本文范围，切勿混用。

——

## 一、系统现况（设备抽奖线）
- 模块与能力
  - 抽奖盘管理：新增/编辑盘，支持抽奖模式（轮次/实时/随机）、自动重置（部署可选展示）。
  - 格子管理：表格视图与宫格视图；类型含商品/优惠券/余额/谢谢参与；商品型可“选择商品”绑定 `goods_id/sku_id`；展示图可选（未填用商品封面）；可设置库存/权重/面值。
  - 设备管理：新增设备（设备SN、归属商家），编辑页可绑定“抽奖盘与价档”，并快捷跳转盘/价档详情与设备价档绑定。
  - 价档管理：新增价档（名称、金额），分润模板支持“比例≤1”或“固定金额”，前端校验“合计≤价档金额”。
  - 抽奖记录：查看命中明细与派生的订单/核销状态（扩展字段）。
  - 分润账单：按设备、价档、时间查看合计与分组分润明细，派生结算状态。
  - 大盘面板：总览盘/设备/格子、累计/今日抽奖次数、累计/今日分润金额；统计今日核销/结算。
- 抽奖执行要点
  - 候选规则：不抽“谢谢参与”；商品型需库存>0。轮次模式仅“本轮可中次数>0”的格子参与；实时权重模式仅权重>0参与。
  - 命中后：商品型扣库存；轮次模式扣“本轮次数”。生成抽奖记录与分润占位账单；商品型生成“0元奖励单”占位，带核销码。

——

## 二、卡点问题与落地方案（只列设备线，给运营看得懂的）
- 奖券/余额发放闭环
  - 现状：命中商品型会生成核销码与占位订单；优惠券/余额型未见“自动发券/入账余额”的动作落地，记录有面值但发放缺口。
  - 影响：运营体验不一致；中奖后用户无凭证或权益未到账。
  - 方案：
    - 优惠券型：命中后在后台触发“发券”到会员账号，并在抽奖记录显示券码/有效期；核销记录新增券核销视图。
    - 余额型：命中后自动入账到会员余额，抽奖记录标记“已入账”，支持撤销与审计。
    - 新增“核销中心”统一列表与搜索（券/实物均可查），状态流转清晰。
- 轮次次数可视化与重置
  - 现状：格子页对“本轮可中次数（round_qty）”可视化不足；一键重置入口不明显。
  - 影响：管理员难以控货与复盘。
  - 方案：在盘页面增加“当前轮次/本轮次数”统计与“一键重置本轮”；格子编辑页显式展示并保存“本轮次数”。
- 活动线与设备线混用风险
  - 现状：活动型抽奖的 `award_json` 与设备线的“盘/格子”是两套。文档/入口混用会误操作。
  - 方案：菜单与文档明确标识“设备抽奖线专用入口”；将活动线菜单隐藏或加红色提示“线上营销（请勿与设备线混用）”。
- 支付→抽奖订单闭环不完整
  - 现状：设备线更偏“设备直接抽奖并生成分润占位单”，与商城支付未完全打通。
  - 方案：落实“价档下单→支付→回调→触发抽奖”的整合流程；若设备侧自带支付，则补登记支付流水并与抽奖记录关联。
- 核销管理视图与流程
  - 现状：主要在抽奖记录里看派生状态；缺统一的核销中心入口与操作链路（扫码校验/撤销/操作人审计）。
  - 方案：新增“核销中心”菜单，支持按核销码/订单/会员查询；记录操作人与时间；可撤销并联动权益回退。
- 设备在线与出货日志
  - 现状：设备列表缺心跳/在线显性展示与出货上报日志；联调 WebSocket 待加强。
  - 方案：设备详情展示“最后心跳/在线状态/出货上报日志”；上线健康度一目了然。
- 钱包与提现闭环
  - 现状：分润账单生成后入账到钱包与提现审批/打款/凭证的闭环需确认。
  - 方案：将“已结算分润”事件化入账到角色钱包；提现流程（申请→审核→打款→凭证→余额同步）打通并可追踪。
- 安全与越权控制
  - 现状：频控（同用户同设备3秒）已做；token鉴权与角色授权需统一落实；设备端请求加签与白名单待完善。
  - 方案：统一接入鉴权中间件；设备端启用签名与白名单；异常风控（并发/重入/重放）策略固化。

——

## 三、设备抽奖线操作SOP（一步一步，避免混用）
- 1) 建价档（抽一次多少钱，钱怎么分）
  - 菜单：幸运抽奖 → 价档管理 → 新增
  - 填：档位名称、金额；配置分润模板（比例或固定金额，校验合计≤金额）
  - 保存后记住 `tier_id`（设备要绑定）
- 2) 新建抽奖盘（16格）
  - 菜单：幸运抽奖 → 抽奖盘 → 新增
  - 填：名称、抽奖模式（推荐“轮次模式”）、是否自动重置本轮
  - 保存后进入“格子配置”
- 3) 配置格子（逐格设置）
  - 奖品类型：商品 / 优惠券 / 余额 / 谢谢参与
  - 商品型：点击“选择商品”绑定 `goods_id/sku_id`；展示图可选（未填自动用商品封面）
  - 其他字段：库存/本轮次数、权重；面值（余额/券面值）
  - 宫格视图支持拖拽调整位置并批量保存
- 4) 绑定设备（上线）
  - 菜单：设备中心 → 抽奖设备 → 编辑设备
  - 录入设备SN、归属商家；绑定抽奖盘与价档（可多档，设默认）
  - 设备在线后即可抽奖（建议先用测试账号试跑）
- 5) 日常巡检与运营
  - 大盘面板看“今日抽奖/分润/核销/结算”
  - 抽奖记录查命中明细与核销状态（券/实物）
  - 分润账单查拆账与结算进度；按设备/价档导出对账
  - 库存控制：轮次模式下“本轮次数”用完进入下一轮（若启用自动重置）；后台有“一键重置本轮”入口
- 6) 核销与售后
  - 实物奖：使用核销码到店核销；支持撤销与备注
  - 优惠券/余额：命中即发券/入账（上线后）；统一在“核销中心”查看状态与操作人

——

## 四、页面映射（只列设备线）
- 幸运抽奖 → 大盘面板：总览数据与今日核销/结算
- 幸运抽奖 → 抽奖盘：列表 / 新增 / 编辑 / 格子配置 / 一键重置本轮
- 幸运抽奖 → 格子管理：表格与宫格视图；新增/编辑格子
- 设备中心 → 抽奖设备：列表 / 新增 / 编辑（绑定盘与价档）
- 幸运抽奖 → 价档管理：列表 / 新增 / 编辑（分润模板）
- 幸运抽奖 → 抽奖记录：列表 / 过滤 / 明细（含核销状态）
- 财务中心 → 分润账单：列表 / 过滤 / 导出 / 结算状态
- 核销中心（新增）：统一核销记录与扫码入口（优惠券/实物）

——

## 五、术语速查
- 抽奖盘（board）：一个设备绑定一个盘；盘下有16个格子
- 格子（slot）：盘上的奖项位；可绑定商品/券/余额
- 价档（tier）：抽一次的金额与分润模板；设备可绑定多个价档
- 轮次模式：本轮次数>0的格子才参与；命中后次数-1
- 实时权重模式：权重>0参与，适合活动导流；注意库存

——

## 六、上线与联调清单（设备线）
- 价档：金额与分润合规；模板校验通过
- 抽奖盘：模式与自动重置设置合理
- 格子：商品型都已绑定 SKU；库存/权重设置完毕；图片展示正常
- 设备：SN录入与绑定盘/价档正确；在线心跳正常
- 抽奖记录：命中数据连续、状态准确（含核销）
- 分润账单：金额与明细正确、可导出
- 核销中心：扫码/核销/撤销/审计可用（上线后）
- 优惠券/余额：命中后权益自动到账（上线后）
- 安全：鉴权与限流、设备加签、越权拦截

——

## 七、版本隔离与防混用
- 在部署侧将“活动型抽奖（线上营销）”菜单隐藏或加醒目警示；本文档与入口仅服务“设备抽奖线”。
- 文档与培训明确：设备线与活动线不可互相引用或配置。

——

## 八、后续排期建议（卡点改造）
- T+3天：优惠券发放/余额入账闭环、核销中心列表与扫码入口
- T+5天：盘页面“本轮次数”可视与一键重置
- T+7天：支付→抽奖订单整合闭环（或支付流水登记）
- T+10天：设备在线状态与出货日志面板化、钱包与提现闭环
- 持续：鉴权与风控策略固化、SOP文档与培训迭代