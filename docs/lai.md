一、项目总目标（一句话）

👉 把 Niushop商城系统 改造成 能抽奖、能分润、能核销、能提现 的商城，
所有会员、商家、代理都走商城体系，
抽奖逻辑和库存控制用咱自己那套 16 宫格逻辑（非随机，轮次+权重可控）。

🧱 二、后台要有的功能板块（每一项都要做）
1️⃣ 奖池管理（价档）

作用： 定义抽奖价格区间，比如 20 元、30 元、50 元 一档。

要做的：

能新增、编辑、启用、禁用奖池。

每个奖池要设置：

最低价 / 最高价

显示价（20元/30元）

状态（启用/禁用）

勾选哪些设备可用这个奖池。

2️⃣ 奖品管理

作用： 管理可抽的奖品（商家或供应商上传的）。

要做的：

奖品名称、类型（实物/优惠券/积分）、活动价、库存、图片。

活动价必须落在奖池区间内才能入池。

一个奖品可以绑定多个奖池。

每个奖品要能设置：

权重（概率控制）

日上限（防止爆仓）

是否大奖（控制展示）

3️⃣ 奖池挂接（核心页面）

作用： 把奖品挂进对应奖池里，配置中奖逻辑。

要做的：

显示当前奖池下的16个格子。

每格可以选择奖品 + 设置权重 + 显示顺序。

底部要有一键重置轮次的按钮。

后台保存时做验证：活动价必须匹配奖池价格范围。

4️⃣ 抽奖逻辑配置（16宫格算法设置）

作用： 后台可控制“轮次+概率”的运行逻辑。

要做的：

模式选择：

✅ 实时概率（每次按权重算）

✅ 轮次控制（按轮次逐个出奖）

✅ 自动重置轮次（库存跑完自动归零）

每个奖品的抽奖权重可以单独调整。

库存为0自动跳过。

5️⃣ 设备管理

作用： 绑定设备与商家/代理身份，控制设备出奖和收益归属。

要做的：

设备号、设备类型、所属商家、供应商、代理、省市区。

每台设备只能绑定一次（要有修改日志）。

心跳/在线状态显示。

设备详情页要能看到：

当前奖池

抽奖记录

出货上报日志。

6️⃣ 分润模板

作用： 控制每次抽奖的收益分配。

要做的：

套餐价（例如20元抽奖）→ 各角色分润金额。

角色包括：

设备主

铺设者

商家

供应商

推广人

代理

平台（剩余自动算）

校验：各角色金额加起来 ≤ 抽奖价。

支持按区域（省市区）保护。

7️⃣ 抽奖记录

作用： 看每次抽奖的明细。

要做的：

按用户、设备、时间筛选。

显示：订单号、支付金额、奖品名称、设备号、是否核销。

支持导出和撤销。

8️⃣ 核销管理

作用： 控制中奖后兑换流程。

要做的：

每次中奖生成唯一二维码（核销码）。

商家或设备端扫码核销 → 更新状态为已核销。

要有“核销记录”列表，能查时间、操作人。

9️⃣ 提现管理

作用： 给商家、代理打钱。

要做的：

申请提现 → 管理员审核 → 审核通过后打款。

要有凭证（截图或转账号）。

支持多渠道（银行卡、USDT等）。

提现完成后更新余额。

⚙️ 三、小程序 / APP 端要做的接口动作

小程序和APP不用改UI，只要换接口逻辑。

操作	调用接口	说明
获取奖池	/api/amount-tiers?device_sn=SN	显示当前设备能用的奖池
获取16宫格奖品	/api/pool/{tier_id}/grid?limit=16	返回16个奖品数据
用户下单	/api/order	创建抽奖订单
支付回调	/api/pay/notify/wx	付款成功触发抽奖
查询结果	/api/order/{id}	查看中奖结果
获取核销码	/api/prize/code/{order_id}	展示二维码核销
钱包余额	/api/wallet/balance	商户、代理钱包余额
提现申请	/api/memberwithdraw/apply	申请提现
🧮 四、抽奖流程（文字流程图）
用户点击抽奖
   ↓
创建订单（带奖池ID）
   ↓
支付成功 → 回调
   ↓
进入抽奖逻辑（按权重选奖）
   ↓
扣库存
   ↓
生成抽奖记录（prize_id、order_id）
   ↓
生成核销码
   ↓
计算分润 → 写入分润流水
   ↓
返回中奖结果给前端
   ↓
（用户核销 / 商户发货）

💰 五、分润流程（人话流程）
支付金额 = P
奖品成本 = K
毛利池 M = P - K
→ 从M里按模板拆账
   ↓
设备主：3元
铺设者：1元
商家：2元
供应商：1元
推广人：2元
代理：1元
平台：剩余自动算
   ↓
写入 profit_record 表
   ↓
提现时汇总结算

🔐 六、测试联调步骤（技术操作顺序）

后台建好奖池 + 奖品 + 分润模板。

设备管理里绑定设备。

小程序用真实接口 /api/amount-tiers 拉奖池数据。

选价档 → 创建订单 → 支付回调。

查看数据库：

ns_order_lottery 是否生成记录。

ns_prize 是否扣库存。

ns_profit_record 是否写入分润。

查看后台抽奖记录列表是否同步更新。

中奖后核销码能扫码 → 核销状态更新。

钱包余额是否增加，提现流程能走通。

🧱 七、验收标准（给外包的打分用）
模块	验收要求
奖池/奖品	能创建、入池校验、库存正常
抽奖逻辑	支付后必中、权重生效、轮次正常
分润	计算准确、流水可查
设备	在线状态更新、出货记录可查
核销	一码一核销、状态更新
提现	申请→审核→打款→余额同步
前端	小程序抽奖→显示中奖→核销完整链路
安全	禁止越权访问，API有token校验