# 幸运抽奖插件（turntable）现状总览

本文为当前代码库中“抽奖插件”的实现现状快照，面向交付与维护。涵盖模块边界、数据与接口、运行与已知问题，便于快速掌握与落地。

## 模块与代码位置
- 管理端控制器：`addon/turntable/admin/controller/Turntable.php`
- 设备价档绑定：`addon/turntable/admin/controller/Bind.php`
- 商家端控制器：`addon/turntable/shop/controller/Turntable.php`
- API 控制器：`addon/turntable/api/controller/Turntable.php`
- 核心模型：`addon/turntable/model/Lottery.php`
- 结算事件：`addon/turntable/event/TurntableSettlement.php`
- 管理端视图（示例）：`addon/turntable/admin/view/...`

## 功能边界（已实现）
- 抽奖盘与格子（16 宫格）：支持实物/虚拟/谢谢参与，权重、库存、本轮次数；支持自动重置轮次。
- 抽奖流程（API）：按权重随机，实物奖需库存>0；支持设备并发锁与频控；命中记录写入 `lottery_record`。
- 奖品列表（API）：按设备或盘返回 16 格；若不足 16 格，自动用真实奖品补齐。
- 价档绑定：设备可绑定价档（金额与分润模板），并在奖品列表回传当前生效价档与分润金额映射（按金额或比例自动识别）。
- 到店核销：用户在小程序/前端提交核销码后，记录 `ext.order.status=verified` 并触发结算事件。
- 地址填写：命中实物可写收件地址至 `lottery_record.ext.shipping_address`。
- 抽奖记录分页：支持按会员或设备查询，未登录时仅允许按设备查询或返回空。
- 分润/结算占位：核销后入队 `lottery_settlement` 并写 `ns_lottery_profit`（幂等更新）。

## 关键数据表（当前使用）
- `device_info`：设备主数据（`device_id/device_sn/site_id/board_id/...`）。
- `lottery_board` / `lottery_slot`：抽奖盘与格子配置（权重、库存、本轮次数）。
- `device_price_bind`：设备-价档绑定（`tier_id/status/start_time/end_time`），唯一性与“仅一个当前生效”约束已在后台新增处理。
- `lottery_price_tier`：价档定义与分润模板（`price/profit_json`）。
- `lottery_record`：抽奖记录（含 `ext.order/shipping_address/profit_roles` 等快照）。
- `ns_lottery_profit`：分润明细（按角色拆账，幂等 upsert）。
- `lottery_settlement`：结算占位（pending→done）。

## 运行时保护
- 并发锁：优先 Redis NX 2s，退化为普通缓存锁；防止并发抽取同一盘库存。
- 频控：同用户同设备 3 秒一次；避免刷接口。
- 幂等：核销与分润均做重复写入保护；分润按 `(record_id, role)` upsert。

## 接入要点
- 设备标识：API 同时兼容 `device_sn` 与 `device_id`，若仅传 `device_id` 会自动解析 `device_sn/board_id`。
- 价档识别：奖品列表会返回生效价档与分润金额（若配置为比例，自动按价档金额计算）。
- 核销触发：到店核销成功后触发事件 `turntable_settlement`，由事件落库分润与结算。

## 已知问题与修复建议
- 管理视图中 `{if ...}` 写入到 `style` 属性会导致 CSS 解析报错（IDE 提示 `css-curlyexpected`）；修复方案：改为通过类（如 `layui-hide`）+ JS 控制显示，避免模板语法置于 `style`。
- 设备端/WS 联调未纳入本插件目录（在 `websocket/`），注意配置 `API_BASE_URL` 与签名环境变量。
- 数据一致性：核销建议升级为事务模式（行级锁）以保证一次核销只结一次账。

## 部署与本地运行（开发态）
- PHP 开发服务：`php -S 127.0.0.1:9100 -t public public/router.php`
- Node WS（可选设备联调）：`websocket/server_new.js`，示例环境变量：
  - `WS_PORT=3003`
  - `API_BASE_URL=http://127.0.0.1:9100/index.php/api`
  - `SOCKET_CALLBACK_SECRET=<可选签名密钥>`

## 交付建议
- 管理端配置 SOP：见 `docs/交接_后台操作SOP_幸运抽奖_人性化版.md`
- 全链路视图与表结构指引：见 `docs/交接_幸运抽奖全链路_落地视图.md`
- 设备价档绑定接口与管理：`addon/turntable/admin/controller/Bind.php`（列表、添加、删除）。

（本页为代码现状的汇总说明，供项目收口与交付参考）