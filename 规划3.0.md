Niushop 幸运大转盘二开集成方案 V2.0 + V3.0（整合终版）

写死版：此文档为落地实施蓝本，禁止删改原文；仅允许在“✅开发打卡区”里标记进度。
目标：两天能交付可商用的“16 宫格实物可控抽奖系统”，直接复用现有小程序/APP UI，仅换接口。
主系统：Niushop（多商户/分销/会员/订单全复用）。
抽奖模式：轮次控制（可控消货） + 实时概率（权重衰减） + 完全随机（备用）。
价格/分润：按抽奖价档位定额分润（非百分比），角色可扩展；平台为剩余自动归集。
设备生态：设备主/铺设者/商家/供应商/推广人/代理（省市区三级区域保护）。
D:\wwwwwwww\36000\chushi10-21\houduanb2b2c5.0.3\clients  原生的小程序和 APP 端
目录

项目背景与目标

版本范围与完成定义（DoD）

业务规则（16 宫格、轮次控制、库存消化、档位分润）

系统架构与模块

数据模型（新增表/字段对接 Niushop）

接口规范（H5/小程序/APP 统一）

抽奖核心算法（可控版）

后台改造（菜单/界面/表单）

权限与角色绑定（含代理区域保护）

设备与价档绑定

分享海报/朋友圈文案

安全、并发与风控

部署上线步骤（两天交付排期）

验收用例与回滚预案

✅开发打卡区（仅允许勾选）

1. 项目背景与目标

Niushop 原生“幸运大转盘”只支持积分奖、12 宫格，不控库存，无法带动线下设备/商家实物转化。

现有独立抽奖系统（FastAdmin 版）逻辑全，但和商城割裂、运维复杂。

本次二开：保持 Niushop 为主系统，将抽奖重写为 16 宫格实物可控引擎，

支持商品绑定、扣减库存、自动生成“0 元订单/奖励单”、支持补发/核销；

支持“轮次-总奖量”可控消货与实时概率权重；

按抽奖价档位定额分润，角色：设备主、铺设者、商家、供应商、推广人、代理、省市区保护、平台兜底。

2. 版本范围与完成定义（DoD）

V1 交付（48 小时）必须达到：

 H5/小程序/APP 抽奖三接口可用（拉奖品/抽一次/查记录）

 16 宫格前端（在原 12 宫格基础上补 4 格，数据位映射新的 16 槽位）

 奖品可绑定 goods_id；抽中后扣库存并生成 0 元订单或发虚拟奖

 轮次控制：本轮奖量到 0 才进下一轮

 价档定额分润：抽一次自动生成分润记录（可结算）

 代理省市区保护 + 推广/分销链兼容

 后台奖品管理/价档管理/设备-价档绑定界面

 日志/风控：同用户/设备频率限制、签名/幂等

V2/V3 继续完善（本文已设计好）：

分享海报/朋友圈自定义文案

统计大盘、告警、异常补发、核销闭环

轮次自动重置、实时概率可视化面板

3. 业务规则（16 宫格、轮次控制、库存消化、档位分润）
3.1 16 宫格

奖盘固定 16 槽位，每槽位绑定一个“奖品项”（可为实物商品或虚拟奖）。

前端补 4 格位图/动画，对应后端新增 slot_no in [1..16]。

3.2 概率三模式

轮次控制（主用）

每个奖品配置“本轮奖量 round_qty”，抽完则 该奖品在本轮概率=0；

所有奖品本轮总量=0 → 自动进入下一轮（按策略是否“自动重置轮次”）。

实时概率（权重）

设 weight_i，可设置“下发后衰减/动态权重”；轮次中未抽完按权重分配概率。

完全随机（备用）

忽略所有权重与轮次，纯等概率（仅测试/活动场景）。

重要：本系统优先走“轮次控制”+“实时权重”，确保可控清货且体验平滑。

3.3 库存消化

绑定 goods_id 的实物奖：

抽中 → 锁定库存 → 生成 0 元订单（待发货/自提核销）；

若库存不足 不允许配置为可抽（或自动切为“下一轮概率=0”）。

虚拟奖：发放积分/优惠券/站内余额。

3.4 价档分润（定额）

抽奖价档（后台配置预置，商家/设备只能选用）：如 20/30/50/100 元。

每个价档配置各角色定额，平台为剩余：

例：20元档
设备主=3，铺设者=1，商家=2，供应商=1，推广人=2，代理=1，平台=20-以上角色之和


分润在“抽中后”记账（可配置为“抽中即结算”或“发货后结算”两种结算点）。

代理支持省/市/区三级保护：同一区域按一人/一条链路优先匹配，找不到归平台。

4. 系统架构与模块

抽奖引擎（核心服务）：轮次、权重、库存校验、下单/发券、分润记账、日志幂等。

Niushop 对接层：会员、订单、商品、分销、优惠券、核销、渠道推广。

设备层：设备注册、绑定价档/可抽奖品、设备->商家->供应商关系。

后台管理：抽奖配置/奖品池/价档/设备绑定/分润账单/核销/异常补发。

前端（你已有）：仅改 BaseURL + 参数对齐。

5. 数据模型（新增表 + 对接 Niushop）

表前缀按你环境调整，以下示意字段覆盖最小必需字段

5.1 奖盘与奖品
-- 奖盘任务（一个商家/设备可绑定一个或多个盘）
CREATE TABLE ns_lottery_board (
  board_id BIGINT PK AUTO_INCREMENT,
  site_id BIGINT NOT NULL,         -- Niushop 站点/商户
  board_name VARCHAR(64) NOT NULL,
  grid_count TINYINT NOT NULL DEFAULT 16, -- 固定16
  round_no INT NOT NULL DEFAULT 1,        -- 当前轮次
  mode ENUM('round','realtime','random') NOT NULL DEFAULT 'round',
  auto_reset_round TINYINT NOT NULL DEFAULT 1, -- 全部为0自动下一轮
  status TINYINT NOT NULL DEFAULT 1,
  create_time DATETIME, update_time DATETIME
);

-- 槽位与奖品
CREATE TABLE ns_lottery_slot (
  slot_id BIGINT PK AUTO_INCREMENT,
  board_id BIGINT NOT NULL,
  slot_no TINYINT NOT NULL,   -- 1..16
  prize_type ENUM('goods','coupon','point','balance','thanks') NOT NULL,
  goods_id BIGINT NULL,       -- prize_type=goods时必填
  prize_name VARCHAR(100) NOT NULL,
  round_qty INT NOT NULL DEFAULT 0,     -- 本轮可中次数
  weight INT NOT NULL DEFAULT 0,        -- 实时权重
  display_img VARCHAR(255) NULL,
  sort INT DEFAULT 0,
  status TINYINT DEFAULT 1,
  UNIQUE(board_id, slot_no)
);

5.2 价档与分润
-- 抽奖价档（平台统一维护）
CREATE TABLE ns_lottery_price_tier (
  tier_id BIGINT PK AUTO_INCREMENT,
  tier_name VARCHAR(32) NOT NULL,    -- 如 20/30/50 元档
  amount DECIMAL(10,2) NOT NULL,
  cfg JSON NOT NULL,  -- {"owner":3,"installer":1,"merchant":2,"supplier":1,"promoter":2,"agent":1}
  status TINYINT NOT NULL DEFAULT 1
);

-- 设备绑定价档（一个设备可绑定多个档位，用于前端选择或固定）
CREATE TABLE ns_device_price_bind (
  id BIGINT PK AUTO_INCREMENT,
  device_id BIGINT NOT NULL,
  tier_id BIGINT NOT NULL,
  is_default TINYINT NOT NULL DEFAULT 0,
  UNIQUE(device_id,tier_id)
);

5.3 设备/身份链路
CREATE TABLE ns_device_info (
  device_id BIGINT PK AUTO_INCREMENT,
  device_sn VARCHAR(64) UNIQUE,
  site_id BIGINT NOT NULL,    -- 关联商家
  owner_id BIGINT NOT NULL,   -- 设备主
  installer_id BIGINT NULL,   -- 铺设者
  supplier_id BIGINT NULL,    -- 供应商
  promoter_id BIGINT NULL,    -- 推广人
  agent_code VARCHAR(32) NULL,-- 代理区域编码（省市区）
  board_id BIGINT NOT NULL,   -- 绑定的抽奖盘
  status TINYINT NOT NULL DEFAULT 1
);

5.4 抽奖记录与订单/分润
CREATE TABLE ns_lottery_record (
  record_id BIGINT PK AUTO_INCREMENT,
  member_id BIGINT NOT NULL,
  device_id BIGINT NULL,
  board_id BIGINT NOT NULL,
  slot_id BIGINT NOT NULL,
  prize_type ENUM('goods','coupon','point','balance','thanks') NOT NULL,
  goods_id BIGINT NULL,
  tier_id BIGINT NOT NULL,     -- 使用的价档
  amount DECIMAL(10,2) NOT NULL,
  round_no INT NOT NULL,
  result ENUM('hit','miss') NOT NULL,
  order_id BIGINT NULL,        -- goods命中生成的订单
  ext JSON NULL,               -- 记录快照
  create_time DATETIME,
  UNIQUE(member_id, device_id, create_time)  -- 幂等辅助
);

CREATE TABLE ns_lottery_profit (
  id BIGINT PK AUTO_INCREMENT,
  record_id BIGINT NOT NULL,
  role ENUM('owner','installer','merchant','supplier','promoter','agent','platform') NOT NULL,
  target_id BIGINT NULL,  -- 对应角色账户/结算主体
  amount DECIMAL(10,2) NOT NULL,
  status ENUM('pending','settled','failed') DEFAULT 'pending',
  settle_point ENUM('hit','deliver') DEFAULT 'hit',
  create_time DATETIME, settle_time DATETIME
);

6. 接口规范（H5/小程序/APP 统一，不改 UI 只换 BaseURL）

路由前缀：/addons/turntable/api/（建议写在单独控制器，便于升级）

6.1 拉取奖品

GET /addons/turntable/api/prize-list?device_id=&board_id=
返回：16 槽位数组（含 prize_name、img、剩余可中次数 round_qty、展示权重 weight，仅前端展示用）。

6.2 抽一次

POST /addons/turntable/api/draw
入参：device_id（或 board_id）、tier_id（价档）、appsessionid/token
流程：

校验会员/token/频率/幂等 → 确认设备可抽/价档可用

选择模式：round 优先 → realtime → random

命中计算（见 §7）

命中为实物：锁库存→创建 0 元订单，写 order_id

写 ns_lottery_record

按价档 cfg 生成 ns_lottery_profit 明细

返回命中槽位/奖品/订单号

返回：

{
  "hit": true,
  "slot_no": 6,
  "prize_type": "goods",
  "goods_id": 123,
  "order_id": 987654321,
  "round_left": 15
}

6.3 抽奖记录

GET /addons/turntable/api/record?page=&page_size=
返回抽奖历史（含订单/核销状态）。

6.4 填写地址/核销

收货地址（实物邮寄）：POST /addons/turntable/api/address

到店核销码：记录里生成 verify_code，走 Niushop 核销组件。

7. 抽奖核心算法（可控版）
function draw(board, mode):
  slots = load 16 slots (status=1)

  if mode == 'round':
     candidates = [s for s in slots if s.round_qty > 0]
     if candidates.empty:
        if board.auto_reset_round:
           board.round_no += 1 ; reset slots.round_qty by next_round_rule
           candidates = [s with round_qty>0]
        else:
           return miss
     // 在 candidates 按 weight 分布（权重为0则均分）
     slot = weighted_random(candidates, key=max(weight,1))
     if slot.prize_type == goods:
         if stock(goods_id) <= 0: set slot.round_qty=0; return draw(board,mode) //回退再选
     hit(slot)
     slot.round_qty -= 1
     return slot

  if mode == 'realtime':
     candidates = [s for s in slots if available(s)] // 可加动态权重衰减
     slot = weighted_random(candidates, weight)
     check_stock_or_retry...
     return slot

  if mode == 'random':
     slot = random(slots)
     check_stock_or_retry...
     return slot


关键点：轮次优先、库存兜底、幂等、中签后立即扣 round_qty。

8. 后台改造（菜单/界面）

路径：营销中心 → 幸运抽奖（顶级）

奖盘管理：新增/编辑（16 宫格，模式、自动重置）

奖品槽位：16 个表单行（奖品类型、绑定商品、轮次量、权重、图片）

价档管理：添加档位金额与角色分润 JSON 可视化编辑器

设备绑定：设备→抽奖盘→可选价档（默认/可选多）

抽奖记录：查询、补发、撤销、核销、异常修复

分润账单：状态流转（pending → settled），结算点可设中签或发货

代理区域：省/市/区导入，绑定代理账号（唯一）

9. 权限与角色绑定（含代理区域保护）

角色链：owner（设备主）→ installer（铺设者）→ merchant（商家）→ supplier（供应商）→ promoter（推广人）→ agent（区域代理）→ platform

区域代理：导入省市区码，每区最多一个有效代理；抽奖时根据商家或设备 area_code 匹配代理；未命中则平台收走。

绑定策略：

设备绑定优先；否则用商家维度绑定；最后系统默认。

推广人从 Niushop 分销链读取（或设备投放二维码携带 inviter）。

10. 设备与价档绑定

设备可以绑定多个价档（如 20/30/50）；

可设“仅默认价档”或“允许前端在绑定档位中切换”。

分润严格按档位 cfg定额发放；平台为剩余。

11. 分享海报/朋友圈文案

商家后台：自定义标题/描述/图片/视频；

海报生成：带设备/商家/邀请人参数二维码；

支持渠道追踪（utm/source）落表。

12. 安全、并发与风控

签名/时间戳/nonce + Token 鉴权；

抽一次接口幂等（按 member_id + 秒级窗口 + 随机盐）；

并发锁：redis SETNX 锁 slot；

频控：同用户/同设备 N 秒一次；

订单、分润记录事务落库，失败自动告警。

13. 部署上线步骤（两天交付排期）

D0（准备）

 拉分支 feature/lottery-16grid；

 导入新增表结构；

 配置 Redis/消息队列（可选）。

D1（后端+后台）

 抽奖引擎（轮次/权重/库存/下单/分润）

 接口 3 个（prize-list、draw、record）

 后台：奖盘/槽位/价档/设备绑定基础页

 生成 0 元订单对接 Niushop 订单流

D2（联调+灰度）

 16 宫格前端联调（你已现成 UI，只换接口）

 实测轮次消化 + 权重命中 + 库存/分润账单

 代理区域 & 推广链路验证

 压测 + 观测 + 告警

 上线单 & 回滚点创建

14. 验收用例与回滚预案

关键用例

 16 宫格展示正确；

 轮次清空后进入下一轮；

 实物命中→锁库存→0 元订单→发货/核销；

 虚拟命中→积分/券到账；

 分润账单=各角色定额 + 平台剩余；

 代理省市区保护生效；

 并发抽奖不越库；

 设备仅能使用绑定价档；

 幂等：重复点击只记一单。

回滚

按发布单回滚到上一稳定 Tag；

回滚脚本撤销表改动（保留数据快照）；

关闭新菜单路由开关。
// ... existing code ...

- 进度标记：继续开发 ✅ （2025-10-21）

 表结构创建（5/5）

 引擎：轮次控制

 引擎：实时权重

 引擎：库存 & 0 元订单

 分润记账（定额）

 代理区域保护

 设备-价档绑定 ✅

 接口：prize-list ✅

 接口：draw（幂等+并发锁） ✅

 接口：record ✅

 接口：address（收货） ✅

 接口：verify（核销） ✅

 后台：奖盘/槽位管理 ✅

 后台：价档管理（可视化 JSON） ✅

 后台：分润账单

 后台：设备绑定（设备→盘） ✅

 分享海报/文案

 压测+告警

 上线 & 回滚点

附：价档与分润示例（可直接落库）
{
  "tier_name": "20元档",
  "amount": 20,
  "cfg": {"owner":3,"installer":1,"merchant":2,"supplier":1,"promoter":2,"agent":1}
}


若各角色合计 < 20，平台 = 20 - 合计；若 > 20，不允许保存。

附：订单对接（简要）

0 元订单：

sku 库存 -1（锁定）；

订单状态：待发货/待自提；

可生成 verify_code 供门店核销；

物流/自提走 Niushop 原生。

你要做什么（超简）

前端不改 UI：把 BaseURL 改到 /addons/turntable/api/*；

后台：按本文创建价档/奖盘/槽位/设备；

两天交付：优先走 轮次控制 + 实物品类 场景，先跑起来，后续再开统计/告警/面板。