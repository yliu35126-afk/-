🧱 牛商城 V5 抽奖系统最终落地方案
一、系统总体框架图（核心逻辑）
┌──────────────────────────────┐
│           用户端（小程序 / APP）             │
│──────────────────────────────│
│ • 扫码进入抽奖页                               │
│ • 支付下单                                     │
│ • 抽奖动画显示                                 │
│ • 展示中奖结果、生成核销码                     │
│ • 点击「进入商城」 → 跳转牛商城首页             │
└──────────────┬──────────────┘
               │ HTTP / WebSocket
               ▼
┌──────────────────────────────┐
│           Node WebSocket 服务层              │
│──────────────────────────────│
│ • 管理设备连接状态                            │
│ • 接收后端开始抽奖指令                        │
│ • 控制设备转盘启动、播放动画                  │
│ • 接收设备返回中奖结果                        │
│ • 回调牛商城后端接口 /api/lottery/result        │
└──────────────┬──────────────┘
               │
               ▼
┌──────────────────────────────┐
│              牛商城 V5 后端                  │
│──────────────────────────────│
│ 模块组成：                                     │
│ • 抽奖盘管理（16 宫格）                        │
│ • 奖品管理（来源：商家 / 供应商）               │
│ • 价档管理（抽奖金额 + 分润模板）              │
│ • 设备管理（绑定价档 / 商家 / 区域）            │
│ • 订单系统（下单 / 支付 / 状态机）              │
│ • 核销中心（扫码 / 后台核销）                   │
│ • 分润账单（ProfitService 计算后入库）          │
│ • 区域代理管理（省 / 市 / 区三级代理）           │
│                                                  │
│ 核心流程：                                      │
│ ① 创建抽奖订单 → ② 支付成功 → ③ 触发设备抽奖 →  │
│ ④ 设备返回中奖结果 → ⑤ 生成核销码 → ⑥ 核销 → ⑦ 分润 │
└──────────────┬──────────────┘
               │
               ▼
┌──────────────────────────────┐
│           数据层（MySQL + Redis）            │
│──────────────────────────────│
│ • MySQL 存储订单、奖品、分润、核销数据         │
│ • Redis 做抽奖并发锁、库存缓存、消息队列       │
└──────────────────────────────┘

二、数据与模块对应关系
模块	关键表	说明
抽奖设备	ns_device	绑定商家、价档、区域、状态
抽奖盘格子	ns_prize_grid	每台设备 16 格配置（奖品 + 权重）
奖品库	ns_prize	商家或供应商提供的奖品
价档管理	ns_price_zone	抽奖金额与 config_json 分润模板
抽奖订单	ns_lottery_order	支付 / 状态 / 奖品 / 核销码
核销记录	ns_verification	商家 / 员工核销记录
分润账单	ns_profit_log	ProfitService 结算结果
区域代理	ns_agent	省 / 市 / 区代理绑定 region_code
会员体系	ns_member	全系统唯一用户表
三、完整业务流程

用户扫码 → 进入抽奖页

调 /api/lottery/order/create 生成订单

记录 device_id、price_zone_id、member_id

支付成功

更新 pay_status=paid

通过 WebSocket 通知设备 start_lottery

设备抽奖 → 返回结果

Node 接收设备 lottery_result 事件

调用 /api/lottery/result 回传结果

后端落库中奖结果

扣减库存

生成核销码（二维码 / 数字码）

写入 ns_verification

更新订单状态

若中奖 → refund_lock=1（禁止退款）

用户到店核销

商家后台 / 小程序扫码核销

核销成功 → verification_status=verified

触发 ProfitService 分润结算

分润结算

读取价档 config_json 分润模板

匹配：平台、省代理、市代理、区代理、商家、供应商、铺设者、设备主、推广员

写入 ns_profit_log

更新受益人余额

禁止退款逻辑

抽完未核销 → 可退由后台判断

已核销 → 禁止退款

四、模块说明（关键功能）
1. 抽奖盘管理

每设备 16 格配置

过滤条件：奖品 活动价 = 价档金额

兜底奖 (fallback) 可设“谢谢参与”

2. 奖品管理

来源：商家 merchant 或 供应商 supplier

字段：标题、封面、活动价、库存、归属 ID

同步 Niushop 商品体系 stock 字段

3. 价档管理

字段：price、config_json

config_json 示例：

{
  "platform":0.30,
  "province_agent":0.15,
  "city_agent":0.10,
  "merchant":0.10,
  "supplier":0.07,
  "installer":0.08,
  "device_owner":0.12,
  "promoter":0.08
}

4. 设备管理

绑定 商家 merchant_id、价档 price_zone_id、地区 region_code

region_code 用于区域代理分润匹配

5. 核销中心

商家或员工扫码核销

自动记录 核销时间 / 操作人

调用 ProfitService 结算分润

6. 分润账单

数据来源：价档模板 × 订单金额

状态：pending → settled → revoked

汇总维度：角色 / 地区 / 设备 / 商家

7. WebSocket 服务

设备维持在线

指令流：

后端 → Node：start_lottery

Node → 设备：控制转盘

设备 → Node：lottery_result

Node → 后端：回调 /api/lottery/result

五、接口清单
接口	方法	作用
/api/lottery/order/create	POST	创建抽奖订单
/api/lottery/pay/notify	POST	支付回调
/api/lottery/result	POST	设备中奖结果回调
/api/lottery/verify	POST	核销确认、触发分润
/api/prize/list	GET	奖品过滤列表
/api/device/grid/save	POST	保存 16 宫格配置
/api/order/refund	POST	后台退款控制
六、执行顺序（技术落地）

完善数据库字段：

ns_device 补 region_code、price_zone_id

ns_price_zone 补 config_json

其余表按上表结构检查

实现接口 1-6
所有逻辑围绕 Niushop 会员体系 ns_member.id

接入 WebSocket

Node 部署常驻

确认 start_lottery 与 lottery_result 双向通信正常

测试流程

支付 → 抽奖 → 落库 → 核销 → 分润

并发库存 100 次无超发

上线监控

日志落 MySQL 或 Redis Channel

分润、退款、核销记录均可追溯

七、关键状态约束
状态字段	取值	说明
pay_status	unpaid / paid / refunded	支付状态
order_status	pending / success / closed	订单流程
lottery_status	none / running / success / lose	抽奖进度
verification_status	none / verified	核销状态
refund_lock	0 / 1	中奖后锁退款
八、前端跳转说明
wx.navigateToMiniProgram({
  appId: '牛商城小程序AppId',
  path: 'pages/index/index',
  envVersion: 'release'
})


抽奖小程序完成抽奖后，用户点击“进入商城”跳转牛商城首页。

九、系统闭环总结
用户下单 → 支付成功 → 设备抽奖 → 奖品入库 → 生成核销码
→ 商家核销 → 分润到账 → 商城展示收益


单一会员体系、单一后台、单一分润逻辑。
设备、商家、供应商、代理、用户全部在牛商城 V5 内闭环。