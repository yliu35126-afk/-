{extend name="app/admin/view/base.html"/}
{block name="resources"}
<style>
  .layui-table-view td:last-child>div{overflow: inherit;}
  .operation-wrap{position: relative;}
  .layui-table-box{overflow: inherit;}
  .layui-table-body{overflow: inherit;}
  .profit-roles div{line-height: 20px;}
  .badge-pending{display:inline-block;padding:2px 8px;border-radius:4px;background:#FFB800;color:#fff;}
  .badge-done{display:inline-block;padding:2px 8px;border-radius:4px;background:#5FB878;color:#fff;}
  .badge-failed{display:inline-block;padding:2px 8px;border-radius:4px;background:#FF5722;color:#fff;}
</style>
{/block}
{block name="main"}
<!-- 筛选 -->
<div class="ns-single-filter-box">
  <div class="layui-form">
    <div class="layui-inline">
      <div class="layui-input-inline" style="width:180px;">
        <input type="number" name="device_id" placeholder="设备ID（可选）" class="layui-input" autocomplete="off">
      </div>
      <div class="layui-input-inline">
        <input type="text" name="start_time" id="start_time" placeholder="开始时间" class="layui-input" autocomplete="off" readonly>
        <i class="ns-calendar"></i>
      </div>
      <div class="layui-input-inline end-time">
        <input type="text" name="end_time" id="end_time" placeholder="结束时间" class="layui-input" autocomplete="off" readonly>
        <i class="ns-calendar"></i>
      </div>
      <button class="layui-btn layui-btn-primary" lay-submit lay-filter="search">搜索</button>
    </div>
  </div>
</div>

<!-- 表格 -->
<div class="layui-tab ns-table-tab">
  <div class="layui-tab-content">
    <table id="profit_list" lay-filter="profit_list"></table>
  </div>
</div>

<script type="text/html" id="action">
  <div class="ns-table-btn">
    <a class="layui-btn" lay-event="retrigger">重触发结算</a>
  </div>
  </script>
{/block}

{block name="script"}
<script>
layui.use(['form','element','laydate'], function(){
  var form = layui.form,
      element = layui.element,
      laydate = layui.laydate,
      table;
  form.render();

  function fmt2(v){ var n = Number(v||0); if (isNaN(n)) return v||''; return n.toFixed(2); }
  function badge(s){ s = String(s||''); if (s==='done') return '<span class="badge-done">已结算</span>'; if (s==='failed') return '<span class="badge-failed">失败</span>'; return '<span class="badge-pending">待结算</span>'; }

  laydate.render({ elem: '#start_time', type: 'datetime' });
  laydate.render({ elem: '#end_time', type: 'datetime' });

  table = new Table({
    elem: '#profit_list',
    url: ns.url('turntable://admin/profit/lists'),
    cols: [[
      { field: 'record_id', title: '记录ID', width: 120 },
      { field: 'device_id', title: '设备ID', width: 100 },
      { field: 'site_id', title: '站点ID', width: 100 },
      { field: 'amount_total', title: '总金额', width: 110, templet: function(d){ return fmt2(d.amount_total); } },
      { field: 'platform_money', title: '平台', width: 100, templet: function(d){ return fmt2(d.platform_money); } },
      { field: 'merchant_money', title: '商户', width: 100, templet: function(d){ return fmt2(d.merchant_money); } },
      { field: 'supplier_money', title: '供应商', width: 100, templet: function(d){ return fmt2(d.supplier_money); } },
      { field: 'promoter_money', title: '推广', width: 100, templet: function(d){ return fmt2(d.promoter_money); } },
      { field: 'installer_money', title: '安装', width: 100, templet: function(d){ return fmt2(d.installer_money); } },
      { field: 'owner_money', title: '运营', width: 100, templet: function(d){ return fmt2(d.owner_money); } },
      { field: 'agent_money', title: '代理', width: 100, templet: function(d){ return fmt2(d.agent_money); } },
      { field: 'member_money', title: '会员', width: 100, templet: function(d){ return fmt2(d.member_money); } },
      { field: 'city_money', title: '城市分站', width: 110, templet: function(d){ return fmt2(d.city_money); } },
      { title: '结算状态', width: 100, templet: function(d){ return badge(d.settlement_status); } },
      { title: '角色快照', width: 240, templet: function(d){ var r=d.roles||{}; return '<div class="profit-roles">'+
        '<div>商家:'+ (r.merchant_site_id||0) +'</div>'+
        '<div>供应商:'+ (r.supplier_id||0) +'</div>'+
        '<div>推广:'+ (r.promoter_id||0) +'</div>'+
        '<div>安装:'+ (r.installer_id||0) +'</div>'+
        '<div>运营:'+ (r.owner_id||0) +'</div>'+
        '<div>代理编码:'+ (r.agent_code||'') +'</div>'+
      '</div>'; } },
      { title: '操作', toolbar: '#action', width: 140 }
    ]]
  });

  form.on('submit(search)', function(data){
    table.reload({
      page: { curr: 1 },
      where: {
        device_id: data.field.device_id || '',
        start_time: data.field.start_time || '',
        end_time: data.field.end_time || ''
      }
    });
    return false;
  });

  table.tool(function(obj){
    var data = obj.data;
    if (obj.event === 'retrigger') {
      ns.nsajax({
        url: ns.url('turntable://admin/profit/retrigger'),
        data: { record_id: data.record_id },
        success: function(res){ layui.layer.msg(res.message||'已触发结算'); table.reload(); }
      });
    }
  });
});
</script>
{/block}