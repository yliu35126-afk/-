{extend name="app/admin/view/base.html"/}
{block name="resources"}
<style>
  .layui-table-view td:last-child>div{overflow: inherit;}
  .operation-wrap{position: relative;}
  .layui-table-box{overflow: inherit;}
  .layui-table-body{overflow: inherit;}
</style>
{/block}
{block name="main"}
<div class="layui-collapse ns-tips">
  <div class="layui-colla-item">
    <h2 class="layui-colla-title">操作提示</h2>
    <ul class="layui-colla-content layui-show">
      <li>价档用于配置抽奖支付金额与分润比例。</li>
    </ul>
  </div>
</div>

<!-- 搜索框 -->
<div class="ns-single-filter-box">
  <button class="layui-btn ns-bg-color" onclick="add()">添加价档</button>
  <div class="layui-form">
    <div class="layui-input-inline">
      <input type="text" name="title" placeholder="请输入价档标题" class="layui-input" autocomplete="off">
      <button type="button" class="layui-btn layui-btn-primary" lay-filter="search" lay-submit>
        <i class="layui-icon">&#xe615;</i>
      </button>
    </div>
  </div>
</div>

<div class="layui-tab ns-table-tab" lay-filter="tier_tab">
  <ul class="layui-tab-title">
    <li class="layui-this" data-status="">全部</li>
    <li data-status="1">启用</li>
    <li data-status="0">禁用</li>
  </ul>
  <div class="layui-tab-content">
    <table id="tier_list" lay-filter="tier_list"></table>
  </div>
</div>

<!-- 状态 -->
<script type="text/html" id="statusTpl">
  {{#  if(d.status == 1){  }}
  启用
  {{#  }else{  }}
  禁用
  {{#  }  }}
</script>

<!-- 操作 -->
<script type="text/html" id="action">
  <div class="ns-table-btn">
    <a class="layui-btn" lay-event="edit">编辑</a>
    <a class="layui-btn" lay-event="del">删除</a>
  </div>
</script>
{/block}

{block name="script"}
<script>
layui.use(['form','element'], function(){
  var form = layui.form,
      element = layui.element,
      table;
  form.render();

  element.on('tab(tier_tab)', function(){
    table.reload({
      page: { curr: 1 },
      where: { 'status': this.getAttribute('data-status') }
    });
  });

  table = new Table({
    elem: '#tier_list',
    url: ns.url('turntable://admin/pricetier/lists'),
    cols: [[
      { field: 'title', title: '价档标题', width: '20%' },
      { field: 'price', title: '金额（元）' },
      { title: '状态', templet: '#statusTpl' },
      { title: '创建时间', templet: function(d){ return ns.time_to_date(d.create_time); } },
      { title: '更新时间', templet: function(d){ return ns.time_to_date(d.update_time); } },
      { title: '操作', toolbar: '#action', width: '20%' }
    ]]
  });

  // 搜索
  form.on('submit(search)', function(data){
    table.reload({
      page: { curr: 1 },
      where: { title: data.field.title }
    });
    return false;
  });

  // 添加
  window.add = function(){
    location.href = ns.url('turntable://admin/pricetier/add');
  };

  // 行事件
  table.tool(function(obj){
    var data = obj.data;
    if (obj.event === 'edit') {
      location.href = ns.url('turntable://admin/pricetier/edit', { tier_id: data.tier_id });
    } else if (obj.event === 'del') {
      layer.confirm('确定删除该价档吗？', function(){
        $.ajax({
          url: ns.url('turntable://admin/pricetier/delete'),
          data: { tier_id: data.tier_id },
          dataType: 'json',
          type: 'POST',
          success: function(res){
            layer.msg(res.message);
            if(res.code === 0){ table.reload(); }
          },
          error: function(xhr){
            console && console.error && console.error('[pricetier.delete] ajax error', xhr && xhr.status, xhr && xhr.responseText);
            layer && layer.msg && layer.msg('删除失败，请稍后重试');
          }
        });
      });
    }
  });
});
</script>
{/block}