{extend name="app/admin/view/base.html"/}
{block name="resources"}
{/block}
{block name="main"}
<div class="layui-row" style="padding:15px;">
  <div class="layui-col-md8">
    <div id="agentMap" style="height:540px;border:1px solid #eee;border-radius:6px;"></div>
  </div>
  <div class="layui-col-md4" style="padding-left:15px;">
    <div class="layui-card">
      <div class="layui-card-header">筛选</div>
      <div class="layui-card-body">
        <div class="layui-form">
          <div class="layui-form-item">
            <label class="layui-form-label">省份</label>
            <div class="layui-input-block">
              <select id="filter_province" lay-filter="filter_province">
                <option value="">全部省份</option>
              </select>
            </div>
          </div>
          <div class="layui-form-item">
            <button class="layui-btn ns-bg-color" id="btnClear">清除筛选</button>
          </div>
          <div class="layui-form-item">
            <p class="layui-text">提示：点击地图上的省份可快速筛选列表；点击行“编辑”可进入编辑界面。</p>
          </div>
        </div>
      </div>
    </div>
    <div class="layui-card" style="margin-top:10px;">
      <div class="layui-card-header">省份统计</div>
      <div class="layui-card-body" id="stats_box">
        加载中...
      </div>
    </div>
  </div>
</div>

<div style="padding:0 15px 15px;">
  <table id="agent_table" lay-filter="agent_table"></table>
  <script type="text/html" id="mapActionTpl">
    <div class="ns-table-btn">
      <a class="layui-btn" lay-event="edit">编辑</a>
    </div>
  </script>
</div>
{/block}

{block name="script"}
<script src="__STATIC__/ext/echarts.min.js"></script>
<script src="__STATIC__/ext/china.js"></script>
<script>
layui.use(['form'], function(){
  var form = layui.form;
  form.render();

  var chart = echarts.init(document.getElementById('agentMap'));
  var provinceIdByName = {}; // { '浙江省': 330000 }
  var nameByProvinceId = {}; // { 330000: '浙江省' }
  var rawList = [];
  var listUrl = ns.url('agent://admin/agent/lists');

  function fetchAll(cb){
    // 统一通过 ns.request 拉取数据，兼容 res.data / 直接数组 两种形态
    ns.request({ url: listUrl, data: { page: 1, page_size: 10000 } }, function(res){
      // res 可能是 data 对象，也可能直接是数组
      if (Array.isArray(res)) {
        rawList = res;
      } else if (res && res.list) {
        rawList = res.list;
      } else if (res && res.data && res.data.list) {
        rawList = res.data.list;
      } else {
        rawList = [];
      }
      // 生成省份映射
      var provSet = {};
      rawList.forEach(function(r){
        if (r.province_name) {
          provSet[r.province_name] = r.province_id;
          provinceIdByName[r.province_name] = r.province_id;
          if (r.province_id) nameByProvinceId[r.province_id] = r.province_name;
        }
      });
      // 填充筛选下拉
      var opts = '<option value="">全部省份</option>';
      Object.keys(provSet).sort().forEach(function(n){
        opts += '<option value="'+provSet[n]+'">'+n+'</option>';
      });
      document.getElementById('filter_province').innerHTML = opts;
      form.render('select');
      cb && cb();
    });
  }

  function buildStats(){
    var counts = {};
    rawList.forEach(function(r){
      var key = r.province_name || '未设置省份';
      counts[key] = (counts[key]||0) + 1;
    });
    var html = Object.keys(counts).sort().map(function(k){
      return '<div style="line-height:28px;">'+k+'：<b>'+counts[k]+'</b></div>';
    }).join('');
    document.getElementById('stats_box').innerHTML = html || '暂无数据';
    return counts;
  }

  function renderMap(){
    var counts = buildStats();
    var data = Object.keys(counts).filter(function(n){return n!=='未设置省份';}).map(function(n){
      return { name: n, value: counts[n] };
    });
    chart.setOption({
      tooltip: { trigger: 'item' },
      visualMap: {
        min: 0,
        max: Math.max.apply(null, data.map(function(d){return d.value;}))||1,
        left: 'left',
        top: 'bottom',
        text: ['高','低'],
        calculable: true,
        inRange: { color: ['#F5F5F5', '#4685FD'] },
        show: false
      },
      series: [{
        name: '代理数量',
        type: 'map',
        map: 'china',
        roam: true,
        label: { show: true, fontSize: 10, color: 'rgba(0,0,0,0.7)' },
        data: data
      }]
    });
  }

  function filterTable(provinceId){
    table.reload({
      page: { curr: 1 },
      where: { province_id: provinceId || '' }
    });
    // 同步筛选器
    if (provinceId && nameByProvinceId[provinceId]) {
      var sel = document.getElementById('filter_province');
      sel.value = String(provinceId);
      form.render('select');
    }
  }

  // 初始化表格
  var table = new Table({
    elem: '#agent_table',
    url: listUrl,
    cols: [[
      { field: 'agent_id', title: 'ID', width: '8%' },
      { field: 'title', title: '标题', width: '26%' },
      { field: 'level_name', title: '级别', width: '12%' },
      { field: 'province_name', title: '省', width: '18%' },
      { field: 'city_name', title: '市', width: '18%' },
      { title: '操作', toolbar: '#mapActionTpl', width: '18%' }
    ]]
  });

  // 行内编辑
  table.tool(function(obj){
    if (obj.event === 'edit') {
      location.href = ns.url('agent://admin/agent/edit', { agent_id: obj.data.agent_id });
    }
  });

  // 地图点击筛选
  chart.on('click', function(params){
    var pname = params && params.name;
    var pid = provinceIdByName[pname];
    filterTable(pid || '');
  });

  // 下拉筛选
  form.on('select(filter_province)', function(data){
    filterTable(data.value || '');
  });
  document.getElementById('btnClear').onclick = function(){ filterTable(''); };

  // 首次加载
  fetchAll(function(){ renderMap(); });
});
</script>
{/block}