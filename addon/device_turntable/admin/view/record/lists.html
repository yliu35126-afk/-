{extend name="app/admin/view/base.html"/}
{block name="resources"}
{/block}
{block name="main"}

<!-- 搜索框 -->
<div class="ns-single-filter-box">
  <div class="layui-form">
    <div class="layui-inline">
      <div class="layui-input-inline">
        <input type="text" name="member_nick_name" placeholder="会员昵称" class="layui-input" autocomplete="off">
      </div>
    </div>
    <div class="layui-inline">
      <div class="layui-input-inline">
        <input type="text" name="start_time" id="start_time" placeholder="开始时间" class="layui-input" autocomplete="off" readonly>
        <i class="ns-calendar"></i>
      </div>
      <div class="layui-input-inline end-time">
        <input type="text" name="end_time" id="end_time" placeholder="结束时间" class="layui-input" autocomplete="off" readonly>
        <i class="ns-calendar"></i>
      </div>
      <button class="layui-btn layui-btn-primary" lay-submit lay-filter="search">搜索</button>
    </div>
  </div>
</div>

<div class="layui-tab ns-table-tab" lay-filter="record_tab">
  <ul class="layui-tab-title">
    <li class="layui-this" data-status="">全部</li>
    <li data-status="1">中奖</li>
    <li data-status="0">未中奖</li>
  </ul>
  <div class="layui-tab-content">
    <table id="record_list" lay-filter="record_list"></table>
  </div>
</div>

{/block}

{block name="script"}
<script>
layui.use(['form', 'element','laydate'], function() {
  var table,
      form = layui.form,
      laydate = layui.laydate,
      element = layui.element;
  form.render();

  //开始时间
  laydate.render({ elem: '#start_time', done: function(value){ start_time = ns.date_to_time(value); } });
  //结束时间
  laydate.render({ elem: '#end_time', done: function(value){ end_time = ns.date_to_time(value); } });

  // Tab 切换过滤
  element.on('tab(record_tab)', function() {
    table.reload({ page: { curr: 1 }, where: { 'status': this.getAttribute('data-status') } });
  });

  table = new Table({
    elem: '#record_list',
    url: ns.url('device_turntable://admin/record/lists'),
    cols: [[
      { field: 'record_id', title: '记录ID', width: 90 },
      { field: 'member_nick_name', title: '会员昵称', width: 140 },
      { field: 'device_id', title: '设备ID', width: 90 },
      { field: 'board_id', title: '盘ID', width: 90 },
      { field: 'prize_type', title: '奖品类型', width: 100, templet: function(d){
          var t = (d.prize_type||'').toLowerCase();
          if (t === 'goods') return '实物';
          if (t === 'balance') return '余额';
          if (t === 'thanks' || t === 'lose' || t === 'miss') return '谢谢参与';
          return t || '-';
      } },
      { field: 'goods_id', title: '商品ID', width: 90 },
      { field: 'award_name', title: '奖项名称', width: 160 },
      { field: 'verify_status', title: '核销状态', width: 100, templet: function(d){
          return (d.verify_status === 'verified') ? '已核销' : '待核销';
      } },
      { title: '核销码', width: 140, templet: function(d){
          try {
            var ext = JSON.parse(d.ext || '{}');
            return (ext.order && ext.order.verify_code) ? ext.order.verify_code : '-';
          } catch(e){ return '-'; }
      } },
      { title: '收件人', width: 120, templet: function(d){
          try { var ext = JSON.parse(d.ext || '{}'); var a = ext.shipping_address||{}; return a.name||'-'; } catch(e){ return '-'; }
      } },
      { title: '联系电话', width: 120, templet: function(d){
          try { var ext = JSON.parse(d.ext || '{}'); var a = ext.shipping_address||{}; return a.mobile||'-'; } catch(e){ return '-'; }
      } },
      { title: '收货地址', minWidth: 200, templet: function(d){
          try { var ext = JSON.parse(d.ext || '{}'); var a = ext.shipping_address||{}; return a.full_address || a.address || '-'; } catch(e){ return '-'; }
      } },
      { title: '支付单号/金额', width: 180, templet: function(d){
          try { var ext = JSON.parse(d.ext || '{}'); var p = ext.pay||{}; if (p.order_no) return p.order_no + ' / ￥' + (p.amount||0); return '-'; } catch(e){ return '-'; }
      } },
      { title: '抽奖时间', width: 160, templet: function(d){ return ns.time_to_date(d.create_time); } }
    ]]
  });

  // 搜索
  form.on('submit(search)', function(data) {
    table.reload({ page: { curr: 1 }, where: data.field });
  });
});
</script>
{/block}