{extend name="app/admin/view/base.html"/}
{block name="main"}
<div class="layui-form ns-form">
  <div class="layui-form-item">
    <label class="layui-form-label">盘ID</label>
    <div class="layui-input-block">
      <input type="number" name="board_id" value="{$board_id|default=''}" placeholder="所属盘ID" class="layui-input">
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">位置</label>
    <div class="layui-input-block">
      <input type="number" name="position" value="" placeholder="0-15" class="layui-input">
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">标题</label>
    <div class="layui-input-block">
      <input type="text" name="title" value="" placeholder="格子标题" class="layui-input">
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">类型</label>
    <div class="layui-input-block">
      <select name="prize_type" id="prize_type">
        <option value="thanks">谢谢参与</option>
        <option value="coupon">优惠券</option>
        <option value="balance">余额</option>
        <option value="goods">商品</option>
      </select>
    </div>
  </div>
  <div class="layui-form-item goods-fields" style="display:none;">
    <label class="layui-form-label">商品ID</label>
    <div class="layui-input-block">
      <input type="number" name="goods_id" value="" placeholder="绑定的商品ID（实物奖）" class="layui-input">
    </div>
  </div>
  <div class="layui-form-item goods-fields" style="display:none;">
    <label class="layui-form-label">SKU ID</label>
    <div class="layui-input-block">
      <input type="number" name="sku_id" value="" placeholder="可选：指定SKU（实物奖）" class="layui-input">
    </div>
  </div>
  <div class="layui-form-item goods-fields" style="display:none;">
    <label class="layui-form-label">来源</label>
    <div class="layui-input-block">
      <select name="source_type">
        <option value="self" selected>自营</option>
        <option value="platform">平台</option>
        <option value="supplier">供应商</option>
      </select>
      <div class="ns-word-aux">仅对实物奖有效，用于后续结算与分润。</div>
    </div>
  </div>
  <div class="layui-form-item goods-fields" style="display:none;">
    <label class="layui-form-label">选择商品</label>
    <div class="layui-input-block">
      <button type="button" class="layui-btn" id="btnSelectGoods">选择商品</button>
      <div id="selectedGoodsInfo" class="ns-word-aux" style="margin-top:8px;"></div>
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">展示图</label>
    <div class="layui-input-block">
      <div class="ns-upload-default" id="slotImgUpload">
        <div class="upload">
          <img src="ADMIN_IMG/upload_img.png" />
          <p>点击上传</p>
        </div>
      </div>
      <div class="operation" style="margin-top:5px;">
        <div>
          <i title="图片预览" class="iconfont iconreview js-preview" style="margin-right: 20px;"></i>
          <i title="删除图片" class="layui-icon layui-icon-delete js-delete"></i>
        </div>
        <div class="replace_img js-replace">点击替换</div>
      </div>
      <input type="hidden" name="img" value="">
      <div class="ns-word-aux">可选：用于格子展示；未上传时用商品封面。</div>
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">库存/次数</label>
    <div class="layui-input-block">
      <input type="number" name="inventory" value="" placeholder="整数" class="layui-input">
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">权重</label>
    <div class="layui-input-block">
      <input type="number" name="weight" value="" placeholder="整数" class="layui-input">
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">面值</label>
    <div class="layui-input-block">
      <input type="number" step="0.01" name="value" value="" placeholder="数值(余额/券面值)" class="layui-input">
    </div>
  </div>
  <div class="ns-form-row">
    <button class="layui-btn ns-bg-color" lay-submit lay-filter="save">保存</button>
    <button class="layui-btn layui-btn-primary" onclick="history.back()">返回</button>
  </div>
</div>
{/block}
{block name="script"}
<script>
layui.use(['form'], function(){
  var form = layui.form;
  form.render();

  function toggleGoodsFields(){
    var v = document.getElementById('prize_type').value;
    var show = v === 'goods';
    var nodes = document.querySelectorAll('.goods-fields');
    for(var i=0;i<nodes.length;i++){ nodes[i].style.display = show ? '' : 'none'; }
  }
  toggleGoodsFields();
  document.getElementById('prize_type').addEventListener('change', toggleGoodsFields);

  // 图片上传控件
  var imgUpload = new Upload({
    elem: '#slotImgUpload'
  });

  // 商品选择器（SKU模式）
  $('#btnSelectGoods').on('click', function(){
    goodsSelect(function(res){
      if(!res || !res.length) return;
      var first = res[0];
      var goodsId = first.goods_id || first;
      var skuId = (first.selected_sku_list && first.selected_sku_list.length) ? first.selected_sku_list[0].sku_id : '';
      var name = first.name || first.goods_name || '';
      var cover = first.cover_img || (first.selected_sku_list && first.selected_sku_list.length ? first.selected_sku_list[0].sku_image : '') || first.image || '';
      $('input[name=goods_id]').val(goodsId);
      $('input[name=sku_id]').val(skuId);
      if(!$('input[name=img]').val() && cover){ $('input[name=img]').val(cover); }
      $('#selectedGoodsInfo').html(name ? ('已选：' + name + (skuId ? ' / SKU ' + skuId : '')) : ('已选商品ID：' + goodsId));
      form.render();
    }, [], {mode: 'sku', disabled: 1});
  });

  form.on('submit(save)', function(data){
    $.ajax({
      url: ns.url('device_turntable://admin/slot/add'),
      data: data.field,
      dataType: 'json',
      type: 'POST',
      success: function(res){
        layer.msg(res.message);
        if(res.code === 0){
          location.href = ns.url('device_turntable://admin/slot/lists', { board_id: data.field.board_id });
        }
      },
      error: function(xhr){
        console && console.error && console.error('[slot.add] ajax error', xhr && xhr.status, xhr && xhr.responseText);
        layer && layer.msg && layer.msg('保存失败，请稍后重试');
      }
    });
    return false;
  });
});
</script>
{/block}