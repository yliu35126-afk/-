(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["otherpages/chat/room/room"],{1177:function(t,e,i){"use strict";i.d(e,"b",(function(){return o})),i.d(e,"c",(function(){return s})),i.d(e,"a",(function(){}));var o=function(){var t=this,e=t.$createElement,i=(t._self._c,t.emjoyShow?t.__map(t.emjoyList,(function(e,i){var o=t.__get_orig(e),s=t.$util.img(e);return{$orig:o,g0:s}})):null);t.$mp.data=Object.assign({},{$root:{l0:i}})},s=[]},"2eab":function(t,e,i){"use strict";i.r(e);var o=i("1177"),s=i("34ed");for(var n in s)["default"].indexOf(n)<0&&function(t){i.d(e,t,(function(){return s[t]}))}(n);i("ea85");var a=i("f0c5"),r=Object(a["a"])(s["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],void 0);e["default"]=r.exports},"34ed":function(t,e,i){"use strict";i.r(e);var o=i("c384"),s=i.n(o);for(var n in o)["default"].indexOf(n)<0&&function(t){i.d(e,t,(function(){return o[t]}))}(n);e["default"]=s.a},9409:function(t,e,i){"use strict";(function(t,e){var o=i("4ea4");i("3a80");o(i("66fd"));var s=o(i("2eab"));t.__webpack_require_UNI_MP_PLUGIN__=i,e(s.default)}).call(this,i("bc2e")["default"],i("543d")["createPage"])},b9d4:function(t,e,i){},c384:function(t,e,i){"use strict";(function(t){var o=i("4ea4");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var s=o(i("2eee")),n=o(i("c973")),a=o(i("213d")),r=o(i("8439")),c=o(i("0f13")),d={components:{chatMessage:function(){Promise.all([i.e("common/vendor"),i.e("otherpages/components/chat-message/chat-message")]).then(function(){return resolve(i("4c2d"))}.bind(null,i)).catch(i.oe)}},data:function(){return{emjoyList:r.default.emjoyList,emjoyShow:!1,chatMore:!1,formData:{content:"",goods_id:0,order_id:0,image:""},isNetWork:!1,send:!1,messageList:[],page:1,isAll:!1,isLoading:0,showLoading:!1,jumpBottom:null,scrollTop:0,scrollPosition:0,siteId:0,skuId:0,orderId:0,siteName:"",shopInfo:{},userInfo:{},style:{},inputFirst:0,inputShow:!1,inputOffsetBottom:0,goods_type:{promotion_name:"",promotion_id:""}}},mixins:[a.default,c.default],computed:{chatBottom:function(){return this.emjoyShow||this.chatMore||this.inputShow}},onLoad:function(e){if(!e.site_id)return this.$util.showToast({title:"缺少必要参数"}),void setTimeout((function(){t.navigateBack()}),1e3);this.siteId=e.site_id,this.getShopInfo(),this.skuId=e.sku_id?e.sku_id:0,this.orderId=e.order_id?e.order_id:0,(this.skuId||this.orderId)&&(this.send=!0),e.type?this.goods_type.promotion_name=e.type:this.goods_type.promotion_name="",e.type_id?this.goods_type.promotion_id=e.type_id:this.goods_type.promotion_id="",t.getStorageSync("token")?(this.getUserInfo(),this.inputFirst=0,this.inputShow=!1,this.inputOffsetBottom=0):this.$util.redirectTo("/pages/login/login/login")},onReady:function(){var e=this;t.onKeyboardHeightChange((function(t){e.inputOffsetBottom=t.height,0===t.height&&(e.focus=!1)}))},methods:{onEditorReady:function(){t.createSelectorQuery().select("#editor").context((function(t){})).exec()},onEditorinput:function(){var e=this;t.createSelectorQuery().select("#editor").context((function(t){e.editorCtx=t.context,e.editorCtx.getContents({success:function(t){e.formData.content=t.html}})})).exec()},openChatMore:function(){var t=this;this.$util.isAndroid&&(this.inputShow=!1,this.inputFirst=1),this.chatMore=!this.chatMore,this.emjoyShow=!1,this.$nextTick((function(){t.setPageScrollTo()}))},getShopInfo:function(){var e=this;0==this.siteId?(this.siteName="平台客服",t.setNavigationBarTitle({title:this.siteName})):this.$api.sendRequest({url:"/api/shop/info",data:{site_id:this.siteId},success:function(i){0==i.code&&(e.shopInfo=i.data,e.siteName=i.data.site_name,t.setNavigationBarTitle({title:e.siteName}))}})},getUserInfo:function(){var t=this;this.$api.sendRequest({url:"/api/member/info",success:function(e){0==e.code&&(t.userInfo=e.data)}})},getChatList:function(){var t=this;this.isAll?t.mescroll&&t.mescroll.endSuccess():this.isLoading||(this.isLoading=!0,1==this.page&&(this.messageList=[]),this.$api.sendRequest({url:"/servicer/api/chat/dialogs",data:{servicer_id:this.servicer_id,page:this.page,limit:7,site_id:t.siteId},success:function(e){if(t.page+=1,e.code>=0&&e.data){console.log(e.data.list.length,"res.data.list"),e.data.list&&e.data.list.length<5&&(t.isAll=!0);var i=0;this.messageList&&(i=this.messageList.slice(-1).id+1);var o=[];if(t.skuId){var s={id:i,isItMe:!0,contentType:"sendGood",sku_id:t.skuId};o.push(s),i+=1}var n=e.data.list;if(n.length)for(var a=0;a<n.length;a++){var r={};0==n[a].content_type?(r.id=i,r.content=0==n[a].type?n[a].consumer_say:n[a].servicer_say,r.isItMe=0==n[a].type,r.contentType="string",r.sendStatus=!0,n[a].avatar?r.avatar=n[a].avatar:r.avatar=n[a].logo):1==n[a].content_type?(r.id=i,r.isItMe=0==n[a].type,1!=n[a].type?r.contentType="goods":r.contentType="goodssku",r.sku_id=n[a].goods_sku_id,r.send=!1,r.sendStatus=!0,n[a].avatar?r.avatar=n[a].avatar:r.avatar=n[a].logo):2==n[a].content_type?(r.id=i,r.isItMe=0==n[a].type,r.contentType="order",r.order_id=n[a].order_id,r.send=!1,r.sendStatus=!0,n[a].avatar?r.avatar=n[a].avatar:r.avatar=n[a].logo):3==n[a].content_type&&(r.id=i,r.isItMe=0==n[a].type,r.contentType="image",r.id=i,r.image=0==n[a].type?n[a].consumer_say:n[a].servicer_say,r.sendStatus=!0,n[a].avatar?r.avatar=n[a].avatar:r.avatar=n[a].logo),o.push(r),i+=1}if(2==t.page){var c={};c.id=i,t.servicer_id>0?c.contentType="online":0==t.servicer_id&&(c.contentType="noline"),o.push(c),i+=1}t.isLoading=!1,o.length&&(t.messageList=o.concat(t.messageList),t.$nextTick((function(){if(2==t.page)t.setPageScrollTo();else{var e="#chat"+o.length;t.setPageScrollTo(e)}})))}else this.$util.showToast({title:e.message})}}))},setPageScrollTo:function(e){if(e){var i=t.createSelectorQuery().in(this).select(e);i.boundingClientRect((function(e){t.pageScrollTo({scrollTop:e.top-30,duration:0})})).exec()}else{var o=t.createSelectorQuery().in(this);o.select(".room-content-box").boundingClientRect((function(e){t.pageScrollTo({scrollTop:e.height-30,duration:0})})).exec()}},sendGood:function(t,e){this.sendMsg("goods"),this.messageList.splice(e,1)},sendOrder:function(t,e){this.sendMsg("order"),this.messageList.splice(e,1)},sendMsg:function(e){if(!this.isNetWork){this.isNetWork=!0;var i=this;if("goods"==e){var o={};""!=this.goods_type.promotion_id&&(o.promotion_id=this.goods_type.promotion_id,o.promotion_name=this.goods_type.promotion_name),this.$api.sendRequest({url:"/servicer/api/chat/say",data:{goods_id:this.skuId,servicer_id:this.servicer_id,content_type:1,site_id:this.siteId,relate_data:JSON.stringify(o)},success:function(t){i.send=!1,i.joinData("send","goods")},complete:function(){i.isNetWork=!1}})}else if("order"==e)this.$api.sendRequest({url:"/servicer/api/chat/say",data:{order_id:this.orderId,servicer_id:this.servicer_id,site_id:this.siteId,content_type:2},success:function(t){i.send=!1,i.joinData("send","order")},complete:function(){i.isNetWork=!1}});else if("image"==e)i.joinData("send","image"),this.$api.sendRequest({url:"/servicer/api/chat/say",data:{message:this.formData.image.trim(),servicer_id:this.servicer_id,site_id:this.siteId,content_type:3},success:function(t){console.log(t,"图片上传成功")},error:function(){var e=this;i.messageList[i.messageList.length-1].sendStatus=!1,t.createSelectorQuery().select("#editor").context((function(t){e.editorCtx=t.context,e.editorCtx.clear()})).exec()},complete:function(){i.isNetWork=!1}});else{var s=this.formData.content,n=s.replace(/<p>/,""),a=n.replace(/<\/p>/,""),r=a.replace(/<br>/,"");if("<p></p>"==s||"<p><br></p>"==s||!r.trim())return this.$util.showToast({title:"发送内容不能为空"}),t.createSelectorQuery().select("#editor").context((function(t){i.editorCtx=t.context,i.editorCtx.clear()})).exec(),void(i.isNetWork=!1);i.joinData("send","string"),this.$api.sendRequest({url:"/servicer/api/chat/say",data:{message:this.formData.content,servicer_id:this.servicer_id,site_id:this.siteId,content_type:0},success:function(e){var o=this;console.log(e,"文字上传成功"),i.formData.content="<p></p>",t.createSelectorQuery().select("#editor").context((function(t){o.editorCtx=t.context,o.editorCtx.clear()})).exec()},error:function(){var e=this;i.messageList[i.messageList.length-1].sendStatus=!1,t.createSelectorQuery().select("#editor").context((function(t){e.editorCtx=t.context,e.editorCtx.clear()})).exec()},complete:function(){i.isNetWork=!1}})}}},joinData:function(t,e){var i=this;return(0,n.default)(s.default.mark((function o(){var n;return s.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:"send"==t&&(n={isItMe:!0,contentType:e,sendStatus:!0},"string"==e?n.content=i.formData.content:"order"==e?n.order_id=i.orderId:"goods"==e?n.sku_id=i.skuId:"image"==e&&(n.image=i.formData.image),i.messageList.push(n),i.$nextTick((function(){i.setPageScrollTo()})));case 1:case"end":return o.stop()}}),o)})))()},hideLoadTips:function(t){var e=this;t?(this.ajax.loadText="消息获取成功",setTimeout((function(){e.ajax.loading=!1}),300)):(this.ajax.loading=!0,this.ajax.loadText="正在获取消息")},onPageScroll:function(t){t.scrollTop<5&&t.scrollTop>=0&&this.getChatList()},inputFocus:function(t){var e=this;this.$util.isAndroid()&&this.inputFirst&&(this.inputShow=!0),this.chatMore=!1,this.$nextTick((function(){e.setPageScrollTo()}))},closePopWindow:function(){this.inputFirst=0,this.chatMore=!1,this.inputShow=!1},openEmjoy:function(){var t=this;console.log(this.emjoyShow,"this.emjoyShow"),this.chatMore=!1,this.emjoyShow=!this.emjoyShow,this.$nextTick((function(){t.setPageScrollTo()}))},addEmjoy:function(e,i){var o=this;t.createSelectorQuery().select("#editor").context((function(t){o.editorCtx=t.context,o.editorCtx.getContents({success:function(t){"<p><br></p>"==t.html&&(t.html="<p></p>");var i=o.$util.img(e),s="<img src="+i+' style="height="20px; width=20px; margin-left=20px;">',n=t.html.replace(/<\/p>$/,s+"</p>");o.editorCtx.setContents({html:n}),o.formData.content=n,o.emjoyShow=!1}})})).exec()},addImg:function(){var t=this;this.$util.upload(1,{path:"chatimg"},(function(e){t.formData.image=e[0],t.sendMsg("image")}),"/servicer/api/chat/chatimg")}},beforeDestroy:function(){clearInterval(this.timeoutObj),this.timeoutObj=null,this.$api.sendRequest({url:"/servicer/api/chat/bye",data:{servicer_id:this.servicer_id,site_id:this.siteId},success:function(e){t.closeSocket()}})}};e.default=d}).call(this,i("543d")["default"])},ea85:function(t,e,i){"use strict";var o=i("b9d4"),s=i.n(o);s.a}},[["9409","common/runtime","common/vendor"]]]);